<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Capoeira PortuguÃªs Trainer</title>
  <style>
  :root {
    --bg: #f0f6ff;      /* light blue */
    --card: #ffffff;     /* white */
    --muted: #475569;    /* slate-600 */
    --text: #0f172a;     /* slate-900 */
    --accent: #2563eb;   /* blue-600 */
    --accent-2: #0ea5e9; /* sky-500 */
    --danger: #ef4444;   /* red-500 */
    --warning: #f59e0b;  /* amber-500 */
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background: linear-gradient(180deg, #f8fbff 0%, #f0f6ff 60%, #ffffff 100%);
    color: var(--text);
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
  }
  header {
    padding: 20px 16px; border-bottom: 1px solid #e5e7eb; backdrop-filter: blur(6px);
    position: sticky; top: 0; z-index: 10; background: rgba(255,255,255,.75);
  }
  .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
  h1 { font-size: 24px; margin: 0 0 6px; letter-spacing: .3px; }
  .sub { color: var(--muted); font-size: 14px; }

  .controls, .card, .result-card {
    background:
      radial-gradient(900px 400px at 10% -10%, rgba(59,130,246,.08), transparent 60%),
      radial-gradient(700px 300px at 110% 10%, rgba(14,165,233,.08), transparent 50%),
      var(--card);
    border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px;
    box-shadow: 0 8px 24px rgba(15,23,42,.08);
  }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; align-items: end; }
  .controls label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
  .controls select, .controls input[type="number"], .controls button {
    width: 100%; padding: 10px 12px; background: #ffffff; color: var(--text);
    border: 1px solid #cbd5e1; border-radius: 10px; outline: none;
  }
  .controls button {
    background: linear-gradient(180deg, #60a5fa, #2563eb);
    border: none; font-weight: 700; letter-spacing: .3px; cursor: pointer; transition: transform .06s ease; color: #ffffff;
  }
  .controls button:active { transform: translateY(1px); }

  .flex-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .pill {
    font-size: 12px; padding: 6px 10px; border-radius: 999px;
    border: 1px solid #cfe0f8; background:#eff6ff; color: #1e3a8a;
  }

  .card { margin-top: 16px; }
  .prompt { font-size: 14px; color: var(--muted); margin-bottom: 6px; display:flex; align-items:center; gap:8px; }
  .q-word { font-size: 32px; font-weight: 800; letter-spacing: .4px; margin: 8px 0 2px; }
  .q-sub { color: var(--muted); font-size: 13px; margin-bottom: 10px; }

  .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: stretch; }
  input[type="text"] {
    width: 100%; padding: 14px 14px; font-size: 18px; border-radius: 12px;
    border: 1px solid #cbd5e1; color: var(--text); background: #ffffff; outline: none;
  }

  .btn { padding: 12px 14px; border-radius: 12px; border: 1px solid #cbd5e1; background: #ffffff; color: var(--text); font-weight: 700; cursor: pointer; }
  .btn.primary { background: linear-gradient(180deg, #60a5fa, #2563eb); border:none; color: #ffffff; }
  .btn.ghost { background: transparent; }
  .btn:disabled { opacity: .5; cursor: not-allowed; }

  .actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }

  .explain { margin-top: 14px; display: none; }
  .explain.show { display: block; }
  .explain h3 { margin: 0 0 8px; font-size: 15px; color: #1d4ed8; }
  .explain p, .explain li { color: #1f2937; line-height: 1.6; }

  .judge { margin-top: 8px; font-weight: 800; }
  .ok { color: var(--accent); }
  .ng { color: var(--danger); }

  .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }

  .progress { height: 10px; background: #ffffff; border:1px solid #e5e7eb; border-radius: 999px; overflow:hidden; margin-top: 12px; }
  .progress > div { height: 100%; background: linear-gradient(90deg, #2563eb, #0ea5e9); width: 0%; }

  .result-card { margin-top: 16px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border-bottom: 1px dashed #e5e7eb; padding: 8px 6px; text-align: left; }
  tr.miss td { background: rgba(239, 68, 68, .06); }

  footer { padding: 18px; text-align: center; color: var(--muted); font-size: 12px; border-top:1px solid #e5e7eb; background:#ffffff80; }
  a { color: #2563eb; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding: 2px 6px; border:1px solid #cbd5e1; border-radius:6px; }
  .hint { color: #1e40af; }
</style>

</head>
<body>
  <header>
    <div class="wrap">
      <h1>Capoeira PortuguÃªs Trainer</h1>
      <div class="sub">ã‚«ãƒã‚¨ã‚¤ãƒ©ã§ä½¿ã†ãƒãƒ«ãƒˆã‚¬ãƒ«èªã‚’ã€ã‚¯ã‚¤ã‚ºå½¢å¼ï¼‹éŸ³å£°ã§å­¦ç¿’ã§ãã¾ã™ã€‚ãƒ†ã‚¹ãƒˆï¼ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã€è§£èª¬ãƒ»ä¾‹æ–‡ã¤ãã€‚</div>
    </div>
  </header>

  <main class="wrap">
    <section class="controls">
      <div>
        <label>å‡ºé¡Œã‚»ãƒƒãƒˆ</label>
        <select id="sel-volume">
          <option value="v1">Vol.1</option>
          <option value="v2">Vol.2</option>
          <option value="v3">Vol.3</option>
          <option value="mix" selected>ãƒŸãƒƒã‚¯ã‚¹ï¼ˆå…¨éƒ¨ï¼‰</option>
        </select>
      </div>
      <div>
        <label>ãƒ¢ãƒ¼ãƒ‰</label>
        <select id="sel-mode">
          <option value="practice" selected>ç·´ç¿’ï¼ˆå³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰</option>
          <option value="exam">ãƒ†ã‚¹ãƒˆï¼ˆæœ€å¾Œã«æ¡ç‚¹ï¼‰</option>
        </select>
      </div>
      <div>
        <label>å•é¡Œæ•°</label>
        <input id="num-qs" type="number" min="5" max="60" step="1" value="15" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btn-start">â–¶ å­¦ç¿’é–‹å§‹</button>
      </div>
      <div class="grid-2" style="grid-column: 1 / -1;">
        <label><input type="checkbox" id="chk-reading-katakana" checked /> èª­ã¿å•é¡Œã¯ã‚«ã‚¿ã‚«ãƒŠå…¥åŠ›ã‚’è¦æ±‚</label>
        <label><input type="checkbox" id="chk-audio-auto" /> æ­£è§£å¾Œã«ä¾‹æ–‡ã‚’è‡ªå‹•ã§èª­ã¿ä¸Šã’</label>
      </div>
    </section>

    <section id="quiz" class="card" style="display:none">
      <div class="flex-row">
        <span class="pill" id="pill-vol"></span>
        <span class="pill" id="pill-kind"></span>
        <span class="pill" id="pill-no"></span>
      </div>
      <div class="prompt" id="prompt"></div>
      <div class="q-word" id="qword"></div>
      <div class="q-sub" id="qsub"></div>

      <div class="row">
        <input type="text" id="answer" placeholder="ã“ã“ã«è§£ç­”ã‚’å…¥åŠ›" autocomplete="off" />
        <button id="btn-speak" class="btn" title="éŸ³å£°ï¼ˆpt-BRï¼‰">ğŸ”Š ç™ºéŸ³</button>
      </div>

      <div class="actions">
        <button id="btn-check" class="btn primary">è§£ç­”ã™ã‚‹</button>
        <button id="btn-skip" class="btn">ã‚¹ã‚­ãƒƒãƒ—</button>
        <button id="btn-show" class="btn ghost">è§£èª¬ã‚’è¡¨ç¤º</button>
        <button id="btn-next" class="btn" disabled>æ¬¡ã¸</button>
      </div>

      <div id="judge" class="judge"></div>

      <div id="explain" class="explain">
        <h3>è§£èª¬ / Dica</h3>
        <div id="explain-text"></div>
        <h3 style="margin-top:12px">ä¼šè©±ä¾‹ / Exemplo</h3>
        <ul class="ex-list" id="examples"></ul>
      </div>

      <div class="progress"><div id="bar"></div></div>
    </section>

    <section id="result" class="result-card" style="display:none">
      <h2>çµæœ</h2>
      <p id="score"></p>
      <div id="review"></div>
      <div class="actions">
        <button class="btn" id="btn-retry">åŒã˜è¨­å®šã§ã‚‚ã†ä¸€åº¦</button>
        <button class="btn" id="btn-home">è¨­å®šã«æˆ»ã‚‹</button>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <details>
        <summary><strong>ä½¿ã„æ–¹ & ä»•æ§˜</strong></summary>
        <ul>
          <li>Vol.1ã€œ3ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é ‚ã„ãŸã‚¢ãƒ´ã‚¡ãƒªã‚¢ã‚½ãƒ³ï¼ˆè©•ä¾¡ãƒ†ã‚¹ãƒˆï¼‰ã‚’å…ƒã«ä½œæˆã€‚èª­ã¿ãƒ»æ„å‘³ãƒ»ã‚¹ãƒšãƒ«ã®3å½¢å¼ã‚’å‡ºé¡Œã—ã¾ã™ã€‚</li>
          <li>å…¥åŠ›ã¯å…¨è§’ãƒ»åŠè§’ãƒ»å¤§æ–‡å­—å°æ–‡å­—ãƒ»ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚’ç„¡è¦–ã—ã¦æ¡ç‚¹ï¼ˆä¾‹ï¼š<span class="kbd">furacÃ£o</span> â‡’ <span class="kbd">FURACAO</span>ã‚‚OKï¼‰ã€‚</li>
          <li>éŸ³å£°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® <code>SpeechSynthesis</code> ã‚’ä½¿ç”¨ï¼ˆãƒãƒ«ãƒˆã‚¬ãƒ«èª(ãƒ–ãƒ©ã‚¸ãƒ«)ã®éŸ³å£°ãŒã‚ã‚‹å ´åˆã«å†ç”Ÿï¼‰ã€‚</li>
          <li>ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã¯å³æ™‚æ¡ç‚¹ï¼‹è§£èª¬ã‚’è¡¨ç¤ºã€‚ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯æœ€å¾Œã«ä¸€è¦§ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
        </ul>
      </details>
    </section>
  </main>

  <footer>
    Made for Capoeira study â€¢ Web Speech API ã‚’ä½¿ç”¨ï¼ˆéŸ³å£°ã®æœ‰ç„¡ã¯ç«¯æœ«ä¾å­˜ï¼‰ â€¢ Â© vocÃª
  </footer>

<script>
// ===== Utility: normalize strings (ignore case/accents) =====
const normalize = (s) => s
  .toString()
  .trim()
  .normalize('NFD')
  .replace(/[\u0300-\u036f]/g, '') // strip accents
  .replace(/\s+/g, ' ')
  .toLowerCase();

const isKatakana = (s) => /[\u30A0-\u30FF]/.test(s);

// SpeechSynthesis helpers
function speak(text, lang='pt-BR') {
  const u = new SpeechSynthesisUtterance(text);
  const voice = speechSynthesis.getVoices().find(v => v.lang.toLowerCase().startsWith(lang.toLowerCase()));
  if (voice) u.voice = voice; else u.lang = lang; 
  u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// ===== Dataset (from the provided tests; added examples & explanations) =====
// key fields: id, vol, kind ('reading'|'meaning'|'spelling'), q, a (array of accepted answers),
// speak: text to pronouce, explain: html, examples: [{pt, ja}]

const DATA = [
  // ------------ Vol.1 --------------
  {id:'v1-read-carrinho', vol:'v1', kind:'reading', q:'carrinho', a:['ã‚«ãƒ’ãƒ¼ãƒ‹ãƒ§','ã‚«ãƒ’ãƒ¼ãƒ‹ãƒ§ãƒ¼'], speak:'carrinho',
    explain:'èªé ­ã® <b>r</b> ã¨èªä¸­ã® <b>rr</b> ã¯ã€Œãƒè¡Œã€ã«è¿‘ã„éŸ³ã€‚<b>nh</b> ã¯ã€Œãƒ‹ãƒ£ã€ã€‚',
    examples:[{pt:'Leve o carrinho devagar.', ja:'å°è»Šã‚’ã‚†ã£ãã‚ŠæŠ¼ã—ã¦ã€‚'}]},
  {id:'v1-read-bolsa', vol:'v1', kind:'reading', q:'bolsa', a:['ãƒœã‚¦ã‚µ','ãƒœã‚¦ã‚¶','ãƒœãƒ«ã‚µ'], speak:'bolsa',
    explain:'èªä¸­ã‚„èªæœ«ã® <b>l</b> ã¯ã€Œã‚¦ã€ã«è¿‘ã„ã€‚åœ°åŸŸã‚„è©±è€…ã§<b>ãƒœãƒ«ã‚µ</b>ã¨èã“ãˆã‚‹å ´åˆã‚‚ã€‚',
    examples:[{pt:'Guarde a bolsa no vestiÃ¡rio.', ja:'ã‹ã°ã‚“ã¯æ›´è¡£å®¤ã«ã—ã¾ã£ã¦ã€‚'}]},
  {id:'v1-read-real', vol:'v1', kind:'reading', q:'real', a:['ãƒ˜ã‚¢ã‚¦','ãƒ˜ã‚¢ã‚¦ãƒ¼'], speak:'real',
    explain:'é€šè²¨åã€‚èªé ­ã® <b>r</b> ã¯ã€Œãƒã€éŸ³ã€èªæœ«ã® <b>l</b> ã¯ã€Œã‚¦ã€ã€‚',
    examples:[{pt:'A mensalidade Ã© vinte reais.', ja:'æœˆè¬ã¯20ãƒ˜ã‚¢ã‚¦ã§ã™ã€‚'}]},
  {id:'v1-read-quinze', vol:'v1', kind:'reading', q:'quinze', a:['ã‚­ãƒ³ã‚ºã‚£','ã‚­ãƒ³ã‚¸'], speak:'quinze',
    explain:'<b>qu</b> ã¯ã€Œã‚­ã€/ã€Œã‚¯ã‚£ã€ã€‚ã“ã®èªã¯ã€Œã‚­ãƒ³ã‚¸ã€ã«è¿‘ã„éŸ³ï¼ˆåœ°åŸŸå·®ã‚ã‚Šï¼‰ã€‚',
    examples:[{pt:'ComeÃ§amos Ã s quinze horas.', ja:'15æ™‚ã«å§‹ã‚ã¾ã™ã€‚'}]},

  {id:'v1-mean-ritmo', vol:'v1', kind:'meaning', q:'ritmo', a:['ãƒªã‚ºãƒ ','æ‹å­'], speak:'ritmo',
    explain:'ç·´ç¿’ä¸­ã«ã‚‚ã‚ˆãå‡ºã‚‹èªã€‚<b>ritmo</b> ã¯ã‚¸ãƒ³ã‚¬ã‚„æ­Œã®ã€Œãƒãƒªã€ã‚’æŒ‡ã™ã“ã¨ã‚‚ã€‚',
    examples:[{pt:'Sinta o ritmo do berimbau.', ja:'ãƒ“ãƒªãƒ³ãƒã‚¦ã®ãƒªã‚ºãƒ ã‚’æ„Ÿã˜ã¦ã€‚'}]},
  {id:'v1-mean-respeito', vol:'v1', kind:'meaning', q:'respeito', a:['æ•¬æ„','å°Šé‡'], speak:'respeito',
    explain:'å…ˆç”Ÿã‚„ä»²é–“ã€ãƒ›ãƒ¼ãƒ€ã¸ã®<b>æ•¬æ„</b>ã€‚æŒ¨æ‹¶ã‚„ãƒãƒŠãƒ¼å…¨èˆ¬ã«ã‚‚ä½¿ã†è¨€è‘‰ã€‚',
    examples:[{pt:'Mostre respeito ao parceiro.', ja:'ç›¸æ‰‹ã«æ•¬æ„ã‚’ç¤ºãã†ã€‚'}]},
  {id:'v1-mean-regional', vol:'v1', kind:'meaning', q:'regional', a:['åœ°åŸŸã®','ãƒ¬ã‚¸ã‚ªãƒŠã‚¦','ãƒ˜ã‚¸ã‚ªãƒŠã‚¦'], speak:'regional',
    explain:'ä¸€èˆ¬èªã¨ã—ã¦ã¯ã€Œåœ°åŸŸã®ã€ã€‚æ–‡è„ˆã«ã‚ˆã£ã¦ã¯ã€Œã‚«ãƒã‚¨ã‚¤ãƒ©ãƒ»ãƒ˜ã‚¸ã‚ªãƒŠã‚¦ï¼ˆRegionalï¼‰ã€æµæ´¾ã‚‚ã€‚',
    examples:[{pt:'Treino regional hoje Ã  noite.', ja:'ä»Šå¤œã¯ãƒ˜ã‚¸ã‚ªãƒŠã‚¦ã®ç·´ç¿’ã€‚'}]},
  {id:'v1-mean-maisumavez', vol:'v1', kind:'meaning', q:'mais uma vez', a:['ã‚‚ã†ä¸€å›','ã‚‚ã†ä¸€åº¦'], speak:'mais uma vez',
    explain:'ç·´ç¿’ã§ã‚ˆãèãæŒ‡ç¤ºã€‚ã€Œ<span class="hint">ã‚‚ã†ä¸€å›ï¼</span>ã€',
    examples:[{pt:'Faz a sequÃªncia mais uma vez!', ja:'ã‚‚ã†ä¸€å›ãã®ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚„ã£ã¦ï¼'}]},
  {id:'v1-mean-devagar', vol:'v1', kind:'meaning', q:'devagar', a:['ã‚†ã£ãã‚Š','ã‚†ã£ãã‚Šã¨'], speak:'devagar',
    explain:'ã‚¹ãƒ”ãƒ¼ãƒ‰èª¿æ•´ã®åŸºæœ¬èªã€‚',
    examples:[{pt:'Vamos devagar primeiro.', ja:'ã¾ãšã¯ã‚†ã£ãã‚Šè¡Œã“ã†ã€‚'}]},
  {id:'v1-mean-tudobem', vol:'v1', kind:'meaning', q:'tudo bem', a:['å…ƒæ°—ã§ã™','å¤§ä¸ˆå¤«ã§ã™','èª¿å­ã„ã„ã‚ˆ'], speak:'tudo bem',
    explain:'æŒ¨æ‹¶ã®å®šç•ªã€‚ã€ŒTudo bem? â€” Tudo.ã€',
    examples:[{pt:'Oi! Tudo bem?', ja:'ã‚„ã‚ï¼å…ƒæ°—ï¼Ÿ'}]},
  {id:'v1-mean-parabens', vol:'v1', kind:'meaning', q:'parabÃ©ns', a:['ãŠã‚ã§ã¨ã†','ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™'], speak:'parabÃ©ns',
    explain:'å¸¯ã®æ˜‡æ ¼ã‚„å‹åˆ©ã‚’ç¥ã†è¨€è‘‰ã€‚',
    examples:[{pt:'ParabÃ©ns pela graduaÃ§Ã£o!', ja:'æ˜‡ç´šãŠã‚ã§ã¨ã†ï¼'}]},
  {id:'v1-mean-vinte', vol:'v1', kind:'meaning', q:'vinte', a:['20','ï¼’ï¼','äºŒå'], speak:'vinte',
    explain:'æ•°è©ã®ç·´ç¿’ã«ã‚‚ã€‚',
    examples:[{pt:'Vinte minutos de alongamento.', ja:'ã‚¹ãƒˆãƒ¬ãƒƒãƒ20åˆ†ã€‚'}]},

  {id:'v1-spell-right', vol:'v1', kind:'spelling', q:'å³', a:['direita'], speak:'direita',
    explain:'å·¦å³ã¯ã‚«ãƒã‚¨ã‚¤ãƒ©ã§é »å‡ºã€‚', examples:[{pt:'Ginga para a direita.', ja:'å³ã«ã‚¸ãƒ³ã‚¬ã—ã¦ã€‚'}]},
  {id:'v1-spell-left', vol:'v1', kind:'spelling', q:'å·¦', a:['esquerda'], speak:'esquerda',
    explain:'<b>esq</b> ã®ã¤ã¥ã‚Šã«æ³¨æ„ã€‚', examples:[{pt:'Esquiva para a esquerda.', ja:'å·¦ã«ã‚¨ã‚¹ã‚­ãƒ¼ãƒ´ã‚¡ã€‚'}]},
  {id:'v1-spell-knife', vol:'v1', kind:'spelling', q:'ãƒŠã‚¤ãƒ•', a:['faca'], speak:'faca',
    explain:'ã‚­ãƒ¡ã®èªå½™ã‚‚å°‘ã—ã€‚', examples:[{pt:'NÃ£o traga faca para o treino.', ja:'ç¨½å¤ã«ãƒŠã‚¤ãƒ•ã¯æŒã£ã¦ã“ãªã„ã§ã­ã€‚'}]},
  {id:'v1-spell-corrido', vol:'v1', kind:'spelling', q:'ã‚³ãƒ’ãƒ¼ãƒ‰ï¼ˆæ­Œã®ç¨®é¡ï¼‰', a:['corrido'], speak:'corrido',
    explain:'æ­Œã®å½¢å¼ã®ä¸€ã¤ã€‚<b>Corridos</b> ã¯ã‚³ãƒ¼ãƒ«ï¼†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€‚', examples:[{pt:'Vamos cantar um corrido!', ja:'ã‚³ãƒ’ãƒ¼ãƒ‰ã‚’æ­ŒãŠã†ï¼'}]},
  {id:'v1-spell-quadra', vol:'v1', kind:'spelling', q:'ã‚¯ã‚¢ãƒ‰ãƒ©ï¼ˆä½“è‚²é¤¨ã‚³ãƒ¼ãƒˆï¼‰', a:['quadra'], speak:'quadra',
    explain:'ç·´ç¿’å ´æ‰€ã§ã‚ˆãä½¿ã†èªã€‚', examples:[{pt:'A quadra estÃ¡ livre hoje.', ja:'ä»Šæ—¥ã¯ã‚³ãƒ¼ãƒˆç©ºã„ã¦ã‚‹ã‚ˆã€‚'}]},
  {id:'v1-spell-red', vol:'v1', kind:'spelling', q:'èµ¤', a:['vermelho','vermelha'], speak:'vermelho',
    explain:'å½¢å®¹è©ã¯èªå°¾ãŒæ€§æ•°ã§å¤‰åŒ–ã€‚', examples:[{pt:'Berimbau vermelho.', ja:'èµ¤ã„ãƒ“ãƒªãƒ³ãƒã‚¦ã€‚'}]},

  // ------------ Vol.2 --------------
  {id:'v2-read-xareu', vol:'v2', kind:'reading', q:'xarÃ©u', a:['ã‚·ãƒ£ãƒ¬ã‚¦'], speak:'xarÃ©u',
    explain:'<b>x</b> ã¯èª­ã¿ãŒå¤šæ§˜ã€‚ã“ã®èªã§ã¯ã€Œã‚·ãƒ£ã€ã€‚', examples:[{pt:'XarÃ©u Ã© um peixe.', ja:'ã‚·ãƒ£ãƒ¬ã‚¦ã¯é­šã®ä¸€ç¨®ã€‚'}]},
  {id:'v2-read-chapeu', vol:'v2', kind:'reading', q:'chapÃ©u', a:['ã‚·ãƒ£ãƒšã‚¦'], speak:'chapÃ©u',
    explain:'<b>ch</b> ã¯ã€Œã‚·ãƒ£ã€ã€‚<b>Ã©u</b> ã®é¼»ã«ã‹ã‹ã‚‰ãªã„äºŒé‡æ¯éŸ³ã«ã‚‚æ³¨æ„ã€‚', examples:[{pt:'Tire o chapÃ©u na roda.', ja:'ãƒ›ãƒ¼ãƒ€ã§ã¯å¸½å­ã‚’è„±ã”ã†ã€‚'}]},
  {id:'v2-read-sequencia', vol:'v2', kind:'reading', q:'sequÃªncia', a:['ã‚»ã‚¯ã‚§ãƒ³ã‚¹ã‚£ã‚¢','ã‚»ã‚¯ã‚¨ãƒ³ã‚·ã‚¢'], speak:'sequÃªncia',
    explain:'2009å¹´ã®æ­£æ›¸æ³•ä»¥é™ã€<b>qÃ¼e</b> ã®åˆ†éŸ³è¨˜å·tremaã¯å»ƒæ­¢ã€‚ãŸã ã—ç™ºéŸ³ç¿’æ…£ã¯ç¶™æ‰¿ã•ã‚Œã‚‹ï¼ˆã€Œã‚»ã‚¯ã‚§â€¦ã€ï¼‰ã€‚',
    examples:[{pt:'Repete a sequÃªncia de golpes.', ja:'æŠ€ã®é€£æºï¼ˆã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ï¼‰ã‚’ã‚‚ã†ä¸€åº¦ã€‚'}]},
  {id:'v2-read-dende', vol:'v2', kind:'reading', q:'dendÃª', a:['ãƒ‡ãƒ³ãƒ‡ãƒ¼'], speak:'dendÃª',
    explain:'èªæœ«ã«ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãŒã‚ã‚‹ã€Œãƒ‡ãƒ³ãƒ‡ãƒ¼ã€ã€‚ãƒã‚¤ãƒ¼ã‚¢æ–™ç†ã«æ¬ ã‹ã›ãªã„ãƒ‘ãƒ¼ãƒ æ²¹ã€‚',
    examples:[{pt:'AcarajÃ© leva azeite de dendÃª.', ja:'ã‚¢ã‚«ãƒ©ã‚¸ã‚§ã«ã¯ãƒ‡ãƒ³ãƒ‡æ²¹ã‚’ä½¿ã†ã€‚'}]},

  {id:'v2-mean-oi', vol:'v2', kind:'meaning', q:'oi', a:['ã‚„ã‚','ã“ã‚“ã«ã¡ã¯','ãŠãƒ¼ã„'], speak:'oi',
    explain:'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªæŒ¨æ‹¶ã€‚', examples:[{pt:'Oi, gente!', ja:'ã‚„ã‚ã€ã¿ã‚“ãªï¼'}]},
  {id:'v2-mean-queixo', vol:'v2', kind:'meaning', q:'queixo', a:['ã‚ã”'], speak:'queixo',
    explain:'å—ã‘èº«ã‚„ã‚¬ãƒ¼ãƒ‰ã®æŒ‡ç¤ºã§é »å‡ºã€‚', examples:[{pt:'Protege o queixo.', ja:'ã‚ã”ã‚’å®ˆã£ã¦ã€‚'}]},
  {id:'v2-mean-cabeca', vol:'v2', kind:'meaning', q:'cabeÃ§a', a:['é ­','ã‚ãŸã¾'], speak:'cabeÃ§a',
    explain:'ã‚»ãƒ³ã‚µãƒ¼ã®ã‚ˆã†ã«å¸¸ã«ç›¸æ‰‹ã‚’ã€Œè¦‹ã‚‹ã€æ„è­˜ã€‚', examples:[{pt:'Mexe a cabeÃ§a no esquiva.', ja:'ã‚¨ã‚¹ã‚­ãƒ¼ãƒ´ã‚¡ã§é ­ã‚’å‹•ã‹ã—ã¦ã€‚'}]},
  {id:'v2-mean-cotovelo', vol:'v2', kind:'meaning', q:'cotovelo', a:['ã²ã˜','è‚˜'], speak:'cotovelo',
    explain:'æ¥è¿‘æˆ¦ã§ã®è·é›¢æ„Ÿã«ã‚‚ã€‚', examples:[{pt:'NÃ£o use o cotovelo aqui.', ja:'ã“ã“ã§ã¯è‚˜ã¯ä½¿ã‚ãªã„ã‚ˆã€‚'}]},
  {id:'v2-mean-joelho', vol:'v2', kind:'meaning', q:'joelho', a:['ã²ã–','è†'], speak:'joelho',
    explain:'ã‚¢ã‚¦ãƒ¼ã‚„ãƒ¡ã‚¤ã‚¢ãƒ»ãƒ«ãƒ¼ã‚¢ã§è†ã‚’å®ˆã‚‹ã€‚', examples:[{pt:'Dobre o joelho.', ja:'è†ã‚’æ›²ã’ã¦ã€‚'}]},
  {id:'v2-mean-quinto', vol:'v2', kind:'meaning', q:'quinto(a)', a:['5ç•ªç›®ã®','äº”ç•ªç›®ã®'], speak:'quinto',
    explain:'åºæ•°è©ã€‚æ€§ä¸€è‡´ã«æ³¨æ„ï¼ˆo/aï¼‰ã€‚', examples:[{pt:'Ele Ã© o quinto da fila.', ja:'å½¼ã¯åˆ—ã®5ç•ªç›®ã€‚'}]},
  {id:'v2-mean-quelegal', vol:'v2', kind:'meaning', q:'Que legal!', a:['ã„ã„ã­','ã„ã„ã­ï¼','ã„ã„ã˜ã‚ƒã‚“','ç´ æ•µ'], speak:'Que legal!',
    explain:'ç§°è³›ã®ã²ã¨ã“ã¨ã€‚', examples:[{pt:'Que jogo bonito! Que legal!', ja:'ã„ã„ã‚¸ãƒ§ãƒ¼ã‚´ã ã­ï¼ã„ã„ã­ï¼'}]},
  {id:'v2-mean-tchau', vol:'v2', kind:'meaning', q:'Tchau', a:['ãƒã‚¤ãƒã‚¤','ã˜ã‚ƒã‚ã­','ã•ã‚ˆã†ãªã‚‰'], speak:'Tchau',
    explain:'åˆ¥ã‚Œã®æŒ¨æ‹¶ã€‚', examples:[{pt:'Tchau, atÃ© amanhÃ£!', ja:'ãƒã‚¤ãƒã‚¤ã€ã¾ãŸæ˜æ—¥ï¼'}]},

  {id:'v2-spell-jogo', vol:'v2', kind:'spelling', q:'ã‚¸ãƒ§ãƒ¼ã‚´ï¼ˆè©¦åˆï¼ãƒ—ãƒ¬ã‚¤ï¼‰', a:['jogo'], speak:'jogo',
    explain:'ã‚«ãƒã‚¨ã‚¤ãƒ©ãã®ã‚‚ã®ã‚’ã€Œjogoï¼ˆã‚¸ãƒ§ãƒ¼ã‚´ï¼‰ã€ã¨ã‚‚è¨€ã†ã€‚', examples:[{pt:'Vamos fazer um jogo.', ja:'ã‚¸ãƒ§ãƒ¼ã‚´ã—ã‚ˆã†ã€‚'}]},
  {id:'v2-spell-corrido', vol:'v2', kind:'spelling', q:'ã‚³ãƒ’ãƒ¼ãƒ‰ï¼ˆæ­Œã®ç¨®é¡ï¼‰', a:['corrido'], speak:'corrido',
    explain:'Vol.1ã¨åŒã˜èªã€‚åå¾©ã§å®šç€ã‚’ã€‚', examples:[{pt:'Canta um corrido clÃ¡ssico.', ja:'å®šç•ªã®ã‚³ãƒ’ãƒ¼ãƒ‰ã‚’æ­Œã£ã¦ã€‚'}]},
  {id:'v2-spell-salvador', vol:'v2', kind:'spelling', q:'ã‚µãƒ«ãƒ´ã‚¡ãƒ‰ãƒ¼ãƒ«ï¼ˆåœ°åï¼‰', a:['salvador','Salvador'], speak:'Salvador',
    explain:'ãƒã‚¤ãƒ¼ã‚¢å·ã®å·éƒ½ã€‚ç™ºéŸ³ã¯ã€Œã‚µã‚¦ãƒ´ã‚¡ãƒ‰ãƒ¼ãƒ«ã€ã«è¿‘ã„ã€‚', examples:[{pt:'Salvador tem muita capoeira.', ja:'ã‚µãƒ«ãƒ´ã‚¡ãƒ‰ãƒ¼ãƒ«ã¯ã‚«ãƒã‚¨ã‚¤ãƒ©ãŒç››ã‚“ã€‚'}]},
  {id:'v2-spell-bahia', vol:'v2', kind:'spelling', q:'ãƒã‚¤ãƒ¼ã‚¢ï¼ˆå·åï¼‰', a:['bahia','Bahia'], speak:'Bahia',
    explain:'ã€Œãƒãƒ’ãƒ¼ã‚¢ã€ã«è¿‘ã„éŸ³ã€‚', examples:[{pt:'Moro na Bahia.', ja:'ç§ã¯ãƒã‚¤ãƒ¼ã‚¢ã«ä½ã‚“ã§ã„ã¾ã™ã€‚'}]},
  {id:'v2-spell-bonfim', vol:'v2', kind:'spelling', q:'ãƒœãƒ³ãƒ•ã‚£ãƒ³æ•™ä¼šï¼ˆç•¥ç§°ï¼‰', a:['igreja do bonfim','igreja nosso senhor do bonfim','igreja de nosso senhor do bonfim'], speak:'Igreja do Bonfim',
    explain:'æ­£å¼ã¯ <i>Igreja Nosso Senhor do Bonfim</i>ã€‚ç•¥ç§°ã‚‚å¯ã€‚', examples:[{pt:'Vamos Ã  Igreja do Bonfim.', ja:'ãƒœãƒ³ãƒ•ã‚£ãƒ³æ•™ä¼šã¸è¡Œã“ã†ã€‚'}]},
  {id:'v2-spell-peixe', vol:'v2', kind:'spelling', q:'é­š', a:['peixe'], speak:'peixe',
    explain:'<b>ei</b> ã¯ã€Œã‚¨ã‚¤ã€ã€‚<b>x</b> ã¯ã“ã“ã§ã¯ã€Œã‚·ã€ã€‚', examples:[{pt:'Esse peixe Ã© xarÃ©u.', ja:'ã“ã®é­šã¯ã‚·ãƒ£ãƒ¬ã‚¦ã ã‚ˆã€‚'}]},

  // ------------ Vol.3 --------------
  {id:'v3-read-saude', vol:'v3', kind:'reading', q:'saÃºde', a:['ã‚µã‚¦ãƒ¼ãƒ‚','ã‚µã‚¦ãƒ¼ã‚¸'], speak:'saÃºde',
    explain:'èªæœ«ã® <b>de</b> ã¯ãƒ–ãƒ©ã‚¸ãƒ«ã§ã¯ã€Œãƒ‚/ã‚¸ã€ã«è¿‘ã„ã€‚<b>Ãº</b> ã¯é•·ã‚ã€‚ä¹¾æ¯ã®æ›ã‘å£°ã«ã‚‚ã€‚',
    examples:[{pt:'SaÃºde! AxÃ©!', ja:'ä¹¾æ¯ï¼ã‚¢ã‚·ã‚§ï¼'}]},
  {id:'v3-read-axe', vol:'v3', kind:'reading', q:'axÃ©', a:['ã‚¢ã‚·ã‚§','ã‚¢ã‚·ã‚§ãƒ¼'], speak:'axÃ©',
    explain:'<b>x</b> ã¯ã“ã“ã§ã¯ã€Œã‚·ã€ã€‚<b>axÃ©</b> ã¯ã€Œè‰¯ã„ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€ã€‚ãƒ›ãƒ¼ãƒ€ã§ã®é›°å›²æ°—ãã®ã‚‚ã®ã€‚',
    examples:[{pt:'Muito axÃ© na roda hoje!', ja:'ä»Šæ—¥ã¯ãƒ›ãƒ¼ãƒ€ã®ã‚¢ã‚·ã‚§ãŒæœ€é«˜ï¼'}]},
  {id:'v3-read-queixo', vol:'v3', kind:'reading', q:'queixo', a:['ã‚±ã‚¤ã‚·ãƒ§'], speak:'queixo',
    explain:'<b>que</b> ã¯ã€Œã‚±ã€ã€‚<b>x</b> ã¯ã“ã®èªã§ã¯ã€Œã‚·ã€ã€‚', examples:[{pt:'Protege o queixo!', ja:'ã‚ã”ã‚’å®ˆã£ã¦ï¼'}]},
  {id:'v3-read-minha', vol:'v3', kind:'reading', q:'minha', a:['ãƒŸãƒ¼ãƒ‹ãƒ£','ãƒŸãƒ‹ãƒ£'], speak:'minha',
    explain:'<b>nh</b> ã¯ã€Œãƒ‹ãƒ£ã€ã€‚ possessivoï¼ˆæ‰€æœ‰å½¢å®¹è©ï¼‰ã€‚', examples:[{pt:'Minha camisa caiu.', ja:'ç§ã®ã‚·ãƒ£ãƒ„ãŒè½ã¡ãŸã€‚'}]},

  {id:'v3-mean-sinho', vol:'v3', kind:'meaning', q:'sinhÃ´', a:['ç”·ä¸»äºº','ã”ä¸»äºº'], speak:'sinhÃ´',
    explain:'æœ¬æ¥ã¯ <b>senhor</b> ã®è¨›ã‚Šã€‚å¥´éš·æ™‚ä»£ã®èªã€‚', examples:[{pt:'O sinhÃ´ mandou chamar.', ja:'ã”ä¸»äººãŒå‘¼ã‚“ã§ã„ã‚‹ã€‚'}]},
  {id:'v3-mean-galo', vol:'v3', kind:'meaning', q:'galo', a:['é›„é¶','ãŠã‚“ã©ã‚Š'], speak:'galo',
    explain:'æ­Œè©ã«ã‚ˆãå‡ºã‚‹èªã€‚', examples:[{pt:'O galo cantou.', ja:'é›„é¶ãŒé³´ã„ãŸã€‚'}]},
  {id:'v3-mean-acucar', vol:'v3', kind:'meaning', q:'aÃ§Ãºcar', a:['ç ‚ç³–'], speak:'aÃ§Ãºcar',
    explain:'ã‚µãƒˆã‚¦ã‚­ãƒ“è¾²åœ’ã®æ­´å²ã¨çµã³ã¤ãèªã€‚', examples:[{pt:'Sem aÃ§Ãºcar, por favor.', ja:'ç ‚ç³–æŠœãã§ãŠé¡˜ã„ã—ã¾ã™ã€‚'}]},
  {id:'v3-mean-escravo', vol:'v3', kind:'meaning', q:'escravo', a:['å¥´éš·'], speak:'escravo',
    explain:'ãƒ–ãƒ©ã‚¸ãƒ«ã®æ­´å²èªå½™ã¨ã—ã¦é‡è¦ã€‚', examples:[{pt:'HistÃ³ria dos escravos no Brasil.', ja:'ãƒ–ãƒ©ã‚¸ãƒ«ã®å¥´éš·ã®æ­´å²ã€‚'}]},
  {id:'v3-mean-esquerda', vol:'v3', kind:'meaning', q:'esquerda', a:['å·¦'], speak:'esquerda',
    explain:'æ–¹å‘èªã€‚<b>esq</b> ã®ç¶´ã‚Šã«æ³¨æ„ã€‚', examples:[{pt:'Gira para a esquerda.', ja:'å·¦ã«å›ã£ã¦ã€‚'}]},
  {id:'v3-mean-cinquenta', vol:'v3', kind:'meaning', q:'cinquenta', a:['50','ï¼•ï¼','äº”å'], speak:'cinquenta',
    explain:'æ•°è©ã€‚<b>qu</b> ã¯ã€Œã‚¯/ã‚­ã€ã§ã¯ãªãã€Œã‚¯ã‚§ã€ã€‚', examples:[{pt:'Cinquenta abdominais!', ja:'è…¹ç­‹50å›ï¼'}]},
  {id:'v3-mean-feliz', vol:'v3', kind:'meaning', q:'feliz', a:['å¹¸ã›ãª','å¬‰ã—ã„'], speak:'feliz',
    explain:'å½¢å®¹è©ã€‚', examples:[{pt:'Fico feliz com seu jogo!', ja:'å›ã®ã‚¸ãƒ§ãƒ¼ã‚´ãŒè¦‹ã‚Œã¦å¬‰ã—ã„ï¼'}]},
  {id:'v3-mean-meu', vol:'v3', kind:'meaning', q:'meu', a:['ç§ã®','ã¼ãã®','ãŠã‚Œã®'], speak:'meu',
    explain:'æ‰€æœ‰å½¢å®¹è©ã€‚æ€§æ•°ä¸€è‡´ã«æ³¨æ„ï¼ˆmeu/minha/meus/minhasï¼‰ã€‚', examples:[{pt:'Esse Ã© meu berimbau.', ja:'ã“ã‚Œã¯ç§ã®ãƒ“ãƒªãƒ³ãƒã‚¦ã€‚'}]},

  {id:'v3-spell-furacao', vol:'v3', kind:'spelling', q:'ç«œå·»', a:['furacao','furacÃ£o'], speak:'furacÃ£o',
    explain:'<b>furacÃ£o</b> ã¯ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã¨é¼»æ¯éŸ³ã«æ³¨æ„ã€‚<b>fracÃ£o</b> ã¨æ›¸ã‹ãªã„ã‚ˆã†ã«ï¼ˆæ„å‘³ãŒå¤‰ã‚ã‚‹ï¼‰ã€‚',
    examples:[{pt:'O furacÃ£o Ã© forte.', ja:'ãã®ç«œå·»ã¯å¼·ã„ã€‚'}]},
  {id:'v3-spell-azul', vol:'v3', kind:'spelling', q:'é’', a:['azul'], speak:'azul',
    explain:'è‰²åã€‚è¤‡æ•°ã¯ <i>azuis</i>ã€‚', examples:[{pt:'A corda Ã© azul.', ja:'å¸¯ã¯é’ã§ã™ã€‚'}]},
  {id:'v3-spell-atabaque', vol:'v3', kind:'spelling', q:'ã‚¢ã‚¿ãƒã‚­ï¼ˆæ¥½å™¨ï¼‰', a:['atabaque'], speak:'atabaque',
    explain:'ã‚«ãƒã‚¨ã‚¤ãƒ©ã®å¤ªé¼“ã€‚', examples:[{pt:'Toque o atabaque.', ja:'ã‚¢ã‚¿ãƒã‚­ã‚’å©ã„ã¦ã€‚'}]},
  {id:'v3-spell-baqueta', vol:'v3', kind:'spelling', q:'ãƒã‚±ãƒ¼ã‚¿ï¼ˆã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‰', a:['baqueta'], speak:'baqueta',
    explain:'ãƒã‚±ãƒ¼ã‚¿ï¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã€‚', examples:[{pt:'Pegue a baqueta do berimbau.', ja:'ãƒ“ãƒªãƒ³ãƒã‚¦ã®ãƒã‚±ãƒ¼ã‚¿ã‚’å–ã£ã¦ã€‚'}]},
  {id:'v3-spell-casa', vol:'v3', kind:'spelling', q:'å®¶', a:['casa'], speak:'casa',
    explain:'åŸºæœ¬èªå½™ã€‚', examples:[{pt:'Volto para casa depois do treino.', ja:'ç¨½å¤ã®å¾Œã€å®¶ã«å¸°ã‚‹ã€‚'}]},
  {id:'v3-spell-deus', vol:'v3', kind:'spelling', q:'ç¥', a:['deus','Deus'], speak:'Deus',
    explain:'æ–‡è„ˆã«ã‚ˆã‚Šå¤§æ–‡å­—ã§ <b>Deus</b>ã€‚', examples:[{pt:'Deus abenÃ§oe a roda.', ja:'ç¥ãŒãƒ›ãƒ¼ãƒ€ã‚’ç¥ç¦ã—ã¾ã™ã‚ˆã†ã«ã€‚'}]},
];

// ===== Quiz engine =====
let STATE = {
  mode: 'practice',
  volume: 'mix',
  qs: [],
  i: 0,
  score: 0,
  review: [],
};

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

function pick(list, n) {
  const arr = [...list];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0, n);
}

function buildSet(volume, count) {
  const pool = DATA.filter(d => volume === 'mix' ? true : d.vol === volume);
  // balance kinds roughly
  const byKind = {
    reading: pool.filter(d=>d.kind==='reading'),
    meaning: pool.filter(d=>d.kind==='meaning'),
    spelling: pool.filter(d=>d.kind==='spelling'),
  };
  const each = Math.max(1, Math.floor(count/3));
  let out = [];
  out = out.concat(pick(byKind.reading, each), pick(byKind.meaning, each), pick(byKind.spelling, each));
  if (out.length < count) {
    const rest = pool.filter(d=>!out.includes(d));
    out = out.concat(pick(rest, count - out.length));
  }
  // shuffle final
  return pick(out, out.length);
}

function startQuiz() {
  STATE.mode = $('#sel-mode').value;
  STATE.volume = $('#sel-volume').value;
  const n = Math.min(Math.max(parseInt($('#num-qs').value||'15',10), 5), 60);
  STATE.qs = buildSet(STATE.volume, n);
  STATE.i = 0; STATE.score = 0; STATE.review = [];
  $('#quiz').style.display = '';
  $('#result').style.display = 'none';
  renderQ();
}

function renderQ() {
  const q = STATE.qs[STATE.i];
  if (!q) return endQuiz();
  $('#pill-vol').textContent = q.vol.toUpperCase();
  $('#pill-kind').textContent = q.kind === 'reading' ? 'èª­ã¿ï¼ˆç™ºéŸ³ï¼‰' : q.kind === 'meaning' ? 'æ„å‘³ï¼ˆæ—¥æœ¬èªï¼‰' : 'ã‚¹ãƒšãƒ«ï¼ˆãƒãƒ«ãƒˆã‚¬ãƒ«èªï¼‰';
  $('#pill-no').textContent = `${STATE.i+1} / ${STATE.qs.length}`;

  const promptText = q.kind === 'reading' ? 'ã“ã®ãƒãƒ«ãƒˆã‚¬ãƒ«èªã®<b>èª­ã¿ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰</b>ã¯ï¼Ÿ' :
                     q.kind === 'meaning' ? 'ã“ã®ãƒãƒ«ãƒˆã‚¬ãƒ«èªã®<b>æ„å‘³ï¼ˆæ—¥æœ¬èªï¼‰</b>ã¯ï¼Ÿ' :
                     'æ—¥æœ¬èªã‚’<b>ãƒãƒ«ãƒˆã‚¬ãƒ«èªã§</b>æ›¸ã„ã¦ãã ã•ã„ã€‚';
  $('#prompt').innerHTML = promptText;
  $('#qword').textContent = q.q;
  $('#qsub').textContent = q.kind === 'spelling' ? 'ã‚¢ã‚¯ã‚»ãƒ³ãƒˆç„¡ã—ã§ã‚‚æ¡ç‚¹OKï¼ˆä¾‹ï¼šfuracaoï¼‰' : '';
  $('#answer').value = '';
  $('#judge').textContent = '';
  $('#explain').classList.remove('show');
  $('#explain-text').innerHTML = q.explain || '';
  $('#examples').innerHTML = (q.examples || []).map(ex => `<li><span class="kbd">${ex.pt}</span> â€” ${ex.ja}</li>`).join('');
  $('#btn-next').disabled = true;
  updateBar();
}

function updateBar() {
  const pct = (STATE.i / STATE.qs.length) * 100;
  $('#bar').style.width = `${pct}%`;
}

function checkAnswer(userAnswer) {
  const q = STATE.qs[STATE.i];
  const raw = (userAnswer || $('#answer').value || '').trim();
  if (!raw) return;

  // type constraints
  if (q.kind === 'reading' && $('#chk-reading-katakana').checked) {
    if (!isKatakana(raw)) {
      $('#judge').innerHTML = `<span class="hint">ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãƒŸãƒ¼ãƒ‹ãƒ£ï¼‰ã€‚</span>`;
      return;
    }
  }

  // Normalize & compare
  const ans = normalize(raw);

  let ok = false;
  for (const a of q.a) {
    // allow katakana variants as is; for PT strings, normalize accents
    const target = q.kind === 'reading' ? a.trim() : normalize(a);
    if ((q.kind === 'reading' ? ans === normalize(a) : ans === target) ||
        // partial matches for meaning (Japanese): accept contains (e.g., "å…ƒæ°—ã§ã™" vs "å…ƒæ°—")
        (q.kind === 'meaning' && normalize(a).length >= 2 && ans.includes(normalize(a))) ) {
      ok = true; break;
    }
  }

  const correctShow = Array.from(new Set(q.a)).join(' / ');
  if (ok) {
    if (STATE.mode === 'practice') STATE.score++;
    $('#judge').innerHTML = `<span class="ok">âœ” æ­£è§£ï¼</span> ç­”ãˆï¼š<span class="kbd">${correctShow}</span>`;
    $('#explain').classList.add('show');
    // auto speak example after correct
    if ($('#chk-audio-auto').checked && q.examples && q.examples[0]) {
      speak(q.examples[0].pt);
    }
  } else {
    $('#judge').innerHTML = `<span class="ng">âœ˜ ä¸æ­£è§£</span> æ­£è§£ï¼š<span class="kbd">${correctShow}</span>`;
    $('#explain').classList.add('show');
  }

  // record review
  STATE.review.push({
    id: q.id, vol:q.vol, kind:q.kind, q:q.q, your: raw, correct: correctShow, ok
  });

  $('#btn-next').disabled = false;
}

function nextQ() {
  STATE.i++;
  if (STATE.i >= STATE.qs.length) return endQuiz();
  renderQ();
}

function endQuiz() {
  // finalize score for exam mode
  if (STATE.mode === 'exam') {
    STATE.score = STATE.review.filter(r=>r.ok).length;
  }
  $('#quiz').style.display = 'none';
  $('#result').style.display = '';
  $('#score').textContent = `æ­£è§£æ•°ï¼š${STATE.score} / ${STATE.qs.length}ï¼ˆæ­£ç­”ç‡ ${(STATE.score/STATE.qs.length*100).toFixed(0)}%ï¼‰`;
  const rows = STATE.review.map(r=>`
    <tr class="${r.ok? '': 'miss'}">
      <td>${r.vol.toUpperCase()}</td>
      <td>${r.kind==='reading'?'èª­ã¿':r.kind==='meaning'?'æ„å‘³':'ã‚¹ãƒšãƒ«'}</td>
      <td>${r.q}</td>
      <td><span class="kbd">${r.correct}</span></td>
      <td>${r.your? `<span class="kbd">${r.your}</span>` : '<span class="muted">ï¼ˆæœªå›ç­”ï¼‰</span>'}</td>
      <td>${r.ok? 'âœ”' : 'âœ˜'}</td>
    </tr>`).join('');
  $('#review').innerHTML = `<div style="overflow:auto; max-height: 420px"><table>
    <thead><tr><th>Vol</th><th>ç¨®åˆ¥</th><th>è¨­å•</th><th>æ­£è§£</th><th>ã‚ãªãŸã®å›ç­”</th><th>åˆ¤å®š</th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;
}

// ===== Wiring =====
$('#btn-start').addEventListener('click', startQuiz);
$('#btn-check').addEventListener('click', ()=>checkAnswer());
$('#btn-next').addEventListener('click', nextQ);
$('#btn-skip').addEventListener('click', ()=>{ STATE.review.push({id:STATE.qs[STATE.i].id, vol:STATE.qs[STATE.i].vol, kind:STATE.qs[STATE.i].kind, q:STATE.qs[STATE.i].q, your:'', correct: Array.from(new Set(STATE.qs[STATE.i].a)).join(' / '), ok:false}); nextQ(); });
$('#btn-show').addEventListener('click', ()=> $('#explain').classList.toggle('show'));
$('#btn-home').addEventListener('click', ()=>{ $('#result').style.display='none'; });
$('#btn-retry').addEventListener('click', startQuiz);
$('#btn-speak').addEventListener('click', ()=>{
  const q = STATE.qs[STATE.i];
  if (q && q.speak) speak(q.speak);
});

// submit with Enter
$('#answer').addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') {
    e.preventDefault();
    if ($('#btn-next').disabled) checkAnswer(); else nextQ();
  }
});

// voice list loading (Chrome loads async)
if (window.speechSynthesis) {
  speechSynthesis.onvoiceschanged = () => {};
}
</script>
</body>
</html>
