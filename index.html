<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capoeira-Português Learning App</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom styles */
        body {
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: #f0f9ff; /* light blue background */
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-bottom-width: 4px;
            border-color: #1d4ed8; /* blue-700 */
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        .fill-in-blank-input {
            border: 2px dashed #9ca3af;
            background-color: #f9fafb;
            text-align: center;
            width: 100px;
            border-radius: 6px;
            margin: 0 4px;
        }
        .fill-in-blank-input:focus {
            outline: none;
            border-style: solid;
            border-color: #3b82f6;
        }
        /* For smooth tab transition */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .speak-btn {
            cursor: pointer;
            color: #6b7280; /* gray-500 */
        }
        .speak-btn:hover {
            color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">Capoeira-Português Learning</h1>
            <p class="text-gray-500 mt-2">カポエイラで使うポルトガル語をマスターしよう！</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex justify-center border-b-2 border-gray-200 mb-8">
            <button id="tab-btn-quiz" class="tab-button flex-1 md:flex-none md:px-8 py-4 text-lg font-semibold text-gray-600 border-b-4 border-transparent" onclick="switchTab('quiz')">
                <i class="fas fa-question-circle mr-2"></i>単語クイズ
            </button>
            <button id="tab-btn-conversation" class="tab-button flex-1 md:flex-none md:px-8 py-4 text-lg font-semibold text-gray-600 border-b-4 border-transparent" onclick="switchTab('conversation')">
                <i class="fas fa-comments mr-2"></i>会話トレーニング
            </button>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Quiz Tab -->
            <div id="tab-content-quiz" class="tab-content">
                <!-- Quiz Setup Screen -->
                <div id="quiz-setup" class="card p-8 text-center">
                    <h2 class="text-2xl font-bold mb-6">クイズ設定</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="quiz-set" class="block mb-2 font-semibold">問題セット:</label>
                            <select id="quiz-set" class="w-full max-w-xs p-2 border rounded-md shadow-sm">
                                <option value="vol1">Vol. 1</option>
                                <option value="vol2">Vol. 2</option>
                                <option value="vol3">Vol. 3</option>
                                <option value="mix">ミックス (Vol. 1-3)</option>
                            </select>
                        </div>
                        <div>
                            <label for="quiz-type" class="block mb-2 font-semibold">出題形式:</label>
                            <select id="quiz-type" class="w-full max-w-xs p-2 border rounded-md shadow-sm">
                                <option value="meaning">ポルトガル語 → 日本語（意味）</option>
                                <option value="spelling">日本語 → ポルトガル語（スペル）</option>
                                <option value="fill-in-blank">穴埋め問題</option>
                            </select>
                        </div>
                    </div>
                    <button id="start-quiz-btn" class="btn btn-primary mt-8 text-lg">
                        <i class="fas fa-play-circle mr-2"></i>クイズ開始
                    </button>
                </div>

                <!-- Quiz Main Screen -->
                <div id="quiz-main" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <p id="quiz-progress" class="font-semibold"></p>
                        <button id="quit-quiz-btn" class="text-gray-500 hover:text-red-500 transition-colors">
                            <i class="fas fa-times-circle mr-1"></i>やめる
                        </button>
                    </div>
                    <div class="card p-8">
                        <div id="question-area" class="text-center mb-6">
                            <p id="question-label" class="text-sm text-gray-500 mb-2"></p>
                            <div class="flex justify-center items-center gap-4">
                               <p id="question-text" class="text-3xl font-bold"></p>
                               <i id="speak-question-main-btn" class="fas fa-volume-up speak-btn text-2xl"></i>
                            </div>
                            <p id="fill-in-blank-hint" class="text-gray-600 mt-2"></p>
                        </div>
                        <div class="flex items-center justify-center">
                            <input type="text" id="answer-input" class="w-full max-w-md p-3 text-lg border-2 border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500 transition" placeholder="答えを入力..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            <button id="submit-answer-btn" class="btn btn-primary ml-2">決定</button>
                        </div>
                        <div id="feedback-area" class="mt-6 text-center hidden">
                            <p id="feedback-text" class="text-2xl font-bold"></p>
                            <div id="explanation-area" class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-400 text-left">
                                <p><strong id="correct-answer-text"></strong></p>
                                <p id="explanation-text" class="mt-2 text-gray-700"></p>
                                <div class="flex items-center mt-2">
                                    <p id="example-sentence-text" class="italic text-gray-700"></p>
                                    <i id="speak-example-btn" class="fas fa-volume-up speak-btn ml-3"></i>
                                </div>
                            </div>
                            <button id="next-question-btn" class="btn btn-primary mt-6">次の問題へ</button>
                        </div>
                    </div>
                </div>

                <!-- Quiz Results Screen -->
                <div id="quiz-results" class="hidden text-center">
                    <div class="card p-8">
                        <h2 class="text-2xl font-bold mb-2">結果発表</h2>
                        <p id="score-text" class="text-4xl font-bold text-blue-600 mb-6"></p>
                        <div id="mistakes-list" class="text-left">
                            <h3 class="font-bold text-xl mb-4">間違えた問題</h3>
                            <!-- Incorrect answers will be populated here -->
                        </div>
                        <div class="mt-8">
                            <button id="restart-quiz-btn" class="btn btn-primary">もう一度挑戦</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation Tab -->
            <div id="tab-content-conversation" class="tab-content">
                <div class="card p-6">
                    <div class="flex flex-col md:flex-row gap-4 mb-6 justify-center items-center">
                        <div class="flex items-center">
                           <label for="conversation-category" class="font-semibold self-center mr-2">カテゴリ:</label>
                           <select id="conversation-category" class="p-2 border rounded-md shadow-sm">
                               <!-- Options will be populated by JS -->
                           </select>
                        </div>
                        <button id="cycle-view-btn" class="btn btn-secondary btn-sm">
                            <!-- Button text will be populated by JS -->
                        </button>
                    </div>
                    <div id="conversation-display" class="space-y-4">
                        <!-- Conversation items will be populated here -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Message Box for alerts -->
        <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                <p id="message-text" class="mb-4 text-lg"></p>
                <button id="message-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>

    </div>

    <script>
    // ===================================================================================
    // DATA SECTION
    // ここにクイズの問題や会話のデータを追加・編集できます。
    // ===================================================================================

    // --- クイズデータ ---
    const quizData = {
        vol1: [
            { portuguese: 'carrinho', japanese: 'カヒーニョ（小さな車、カポエイラの動き）', reading: 'カヒーニョ', explanation: '語頭のr、語中のrrはハ行の音。nhは「ニャ行」の音になります。カポエイラでは低い姿勢で移動する動きの名前です。', exampleSentence: 'Faça o carrinho para passar por baixo.', fillInBlank: { question: 'ca___inho', answer: 'rrh' } },
            { portuguese: 'bolsa', japanese: 'カバン', reading: 'ボウサ', explanation: '母音と子音に挟まれたLは「ウ」のように発音されます。', exampleSentence: 'Minha bolsa de capoeira é pesada.', fillInBlank: { question: 'bo___sa', answer: 'l' } },
            { portuguese: 'real', japanese: 'レアル（ブラジルの通貨）', reading: 'ヘアウ', explanation: '語頭のrはハ行の音、語末のlは「ウ」の音になります。', exampleSentence: 'Um pão de queijo custa três reais.', fillInBlank: { question: '___al', answer: 're' } },
            { portuguese: 'quinze', japanese: '15', reading: 'キンズィ', explanation: 'quiは「キ」と発音します。', exampleSentence: 'A aula começa em quinze minutos.', fillInBlank: { question: '___nze', answer: 'qui' } },
            { portuguese: 'ritmo', japanese: 'リズム', reading: 'ヒットモ', explanation: 'カポエイラの音楽やジョーゴ（ゲーム）に合わせるための重要な要素です。', exampleSentence: 'Siga o ritmo do berimbau.', fillInBlank: { question: '___tmo', answer: 'ri' } },
            { portuguese: 'respeito', japanese: '敬意', reading: 'ヘスペイト', explanation: 'カポエイラにおいて、メストレ（先生）や仲間、伝統に対する敬意は非常に大切です。', exampleSentence: 'Tenha respeito pelo seu mestre.', fillInBlank: { question: 'res___ito', answer: 'pe' } },
            { portuguese: 'regional', japanese: 'ヘジオナウ（地域の）', reading: 'ヘジオナウ', explanation: 'Mestre Bimbaが創設したカポエイラのスタイル「Capoeira Regional」を指します。', exampleSentence: 'Eu treino Capoeira Regional.', fillInBlank: { question: 'regio___', answer: 'nal' } },
            { portuguese: 'mais uma vez', japanese: 'もう一回', reading: 'マイス ウマ ヴェス', explanation: '練習中によく使われるフレーズです。', exampleSentence: 'Vamos, mais uma vez!', fillInBlank: { question: 'mais uma ___', answer: 'vez' } },
            { portuguese: 'devagar', japanese: 'ゆっくり', reading: 'デヴァガール', explanation: '動きを正確に学ぶために、ゆっくり練習することは大切です。', exampleSentence: 'Faça o movimento devagar.', fillInBlank: { question: 'deva___', answer: 'gar' } },
            { portuguese: 'tudo bem', japanese: '元気です、大丈夫です', reading: 'トゥード ベン', explanation: '挨拶でよく使われる表現。「Oi, tudo bem?」のように使います。', exampleSentence: 'Oi, tudo bem? - Tudo bem!', fillInBlank: { question: 'tudo ___', answer: 'bem' } },
            { portuguese: 'parabéns', japanese: 'おめでとう', reading: 'パラベンス', explanation: '誕生日やバチザード（昇段式）で使います。', exampleSentence: 'Parabéns pela sua nova corda!', fillInBlank: { question: 'para___', answer: 'béns' } },
            { portuguese: 'vinte', japanese: '20', reading: 'ヴィンチ', explanation: '数字の20。体力トレーニングで回数を数える時などに出てきます。', exampleSentence: 'Vamos fazer vinte flexões.', fillInBlank: { question: 'vin___', answer: 'te' } },
            { portuguese: 'direita', japanese: '右', reading: 'ジレイタ', explanation: '動きの方向を指示する時に使います。', exampleSentence: 'Ginga para a direita.', fillInBlank: { question: 'di___ita', answer: 're' } },
            { portuguese: 'esquerda', japanese: '左', reading: 'エスケルダ', explanation: '動きの方向を指示する時に使います。', exampleSentence: 'Esquiva para a esquerda.', fillInBlank: { question: 'es___rda', answer: 'que' } },
            { portuguese: 'faca', japanese: 'ナイフ', reading: 'ファッカ', explanation: 'カポエイラの歌には、武器に関する言葉が登場することがあります。', exampleSentence: 'A letra da música fala sobre uma faca.', fillInBlank: { question: 'fa___', answer: 'ca' } },
            { portuguese: 'corrido', japanese: 'コヒード（カポエイラの歌の形式）', reading: 'コヒード', explanation: 'コールアンドレスポンス形式の短い歌のことです。', exampleSentence: 'Vamos cantar um corrido agora.', fillInBlank: { question: 'co___ido', answer: 'rr' } },
            { portuguese: 'quadra', japanese: 'クアドラ（カポエイラの歌の形式）', reading: 'クアドラ', explanation: '4行詩からなる歌の形式です。', exampleSentence: 'Essa música é uma quadra.', fillInBlank: { question: '___dra', answer: 'qua' } },
            { portuguese: 'vermelho', japanese: '赤', reading: 'ヴェルメーリョ', explanation: '色の名前。lhは「リャ行」の音になります。', exampleSentence: 'A corda do mestre é vermelha.', fillInBlank: { question: 'verme___o', answer: 'lh' } }
        ],
        vol2: [
            { portuguese: 'xaréu', japanese: 'シャレウ（魚の名前）', reading: 'シャレウ', explanation: 'xは「シャ行」の音。カポエイラの歌によく出てくる魚の名前です。', exampleSentence: 'Na maré, eu vi um xaréu.', fillInBlank: { question: '___réu', answer: 'xa' } },
            { portuguese: 'chapéu', japanese: '帽子', reading: 'シャペウ', explanation: 'chは「シャ行」の音。「chapéu de couro（革の帽子）」という技があります。', exampleSentence: 'Ele usa um chapéu de couro.', fillInBlank: { question: 'cha___u', answer: 'pé' } },
            { portuguese: 'sequência', japanese: '連続、一連の動き', reading: 'セクェンスィア', explanation: 'queは「クェ」と発音。技を連続して行う練習を指します。', exampleSentence: 'Vamos treinar a sequência de Mestre Bimba.', fillInBlank: { question: 'se___ncia', answer: 'quê' } },
            { portuguese: 'dendê', japanese: 'デンデ油、気迫', reading: 'デンデー', explanation: 'バイーア料理に使われるアブラヤシの油。カポエイラでは「気迫」や「エネルギー」といった意味でも使われます。', exampleSentence: 'Jogue com dendê!', fillInBlank: { question: 'den___', answer: 'dê' } },
            { portuguese: 'oi', japanese: 'やあ', reading: 'オイ', explanation: '英語のHiにあたる、気軽な挨拶です。', exampleSentence: 'Oi, galera!', fillInBlank: { question: 'o___', answer: 'i' } },
            { portuguese: 'queixo', japanese: 'あご', reading: 'ケイショ', explanation: 'Queixada（ケイシャーダ）という蹴り技は「あごへの蹴り」という意味です。', exampleSentence: 'Cuidado com o queixo.', fillInBlank: { question: 'quei___', answer: 'xo' } },
            { portuguese: 'cabeça', japanese: '頭', reading: 'カベッサ', explanation: 'Cabeçada（カベサーダ）は頭突きのことです。', exampleSentence: 'Proteja sua cabeça.', fillInBlank: { question: 'ca___ça', answer: 'be' } },
            { portuguese: 'cotovelo', japanese: 'ひじ', reading: 'コトヴェーロ', explanation: 'Cotovelada（コトヴェラーダ）は肘打ちです。', exampleSentence: 'Ele usou o cotovelo na defesa.', fillInBlank: { question: 'coto___lo', answer: 've' } },
            { portuguese: 'joelho', japanese: 'ひざ', reading: 'ジョエーリョ', explanation: 'Joelhada（ジョエリャーダ）は膝蹴りです。', exampleSentence: 'Dobre o joelho para a ginga.', fillInBlank: { question: 'joe___o', answer: 'lh' } },
            { portuguese: 'quinto', japanese: '5番目の', reading: 'キント', explanation: '序数。順番を表すときに使います。', exampleSentence: 'Ele é o quinto da fila.', fillInBlank: { question: '___nto', answer: 'qui' } },
            { portuguese: 'Que legal!', japanese: 'いいね！、すごい！', reading: 'キ レガウ', explanation: 'ポジティブな感情を表す、非常によく使う口語表現です。', exampleSentence: 'Você aprendeu aú? Que legal!', fillInBlank: { question: 'Que ___!', answer: 'legal' } },
            { portuguese: 'Tchau', japanese: 'バイバイ', reading: 'チャウ', explanation: '別れ際の挨拶。イタリア語が語源です。', exampleSentence: 'Tchau, até amanhã!', fillInBlank: { question: '___au', answer: 'Tch' } },
            { portuguese: 'jogo', japanese: 'ゲーム、試合', reading: 'ジョーゴ', explanation: 'カポエイラのホーダの中で2人が行う攻防のこと。', exampleSentence: 'Vamos fazer um bom jogo.', fillInBlank: { question: 'jo___', answer: 'go' } },
            { portuguese: 'Salvador', japanese: 'サルヴァドール', reading: 'サウヴァドール', explanation: 'ブラジル・バイーア州の州都で、カポエイラが深く根付いている都市です。', exampleSentence: 'Mestre Bimba nasceu em Salvador.', fillInBlank: { question: 'Salva___', answer: 'dor' } },
            { portuguese: 'Bahia', japanese: 'バイーア', reading: 'バイーア', explanation: 'ブラジル北東部の州。アフリカ文化の影響が強く、カポエイラ発祥の地とされています。', exampleSentence: 'Capoeira nasceu na Bahia.', fillInBlank: { question: 'Ba___a', answer: 'hi' } },
            { portuguese: 'Igreja do Bonfim', japanese: 'ボンフィン教会', reading: 'イグレージャ ド ボンフィン', explanation: 'サルヴァドールにある有名な教会。願いが叶うと言われるリボン（Fita）が有名です。', exampleSentence: 'Amarre a fita do Bonfim no seu pulso.', fillInBlank: { question: 'Igreja do ___', answer: 'Bonfim' } },
            { portuguese: 'peixe', japanese: '魚', reading: 'ペイシ', explanation: 'カポエイラの歌には、海や魚に関するものが多くあります。', exampleSentence: 'O pescador pegou um peixe grande.', fillInBlank: { question: 'pei___', answer: 'xe' } }
        ],
        vol3: [
            { portuguese: 'saúde', japanese: '健康、乾杯', reading: 'サウージ', explanation: '乾杯の音頭として最も一般的に使われます。「健康を祝して！」という意味です。', exampleSentence: 'Um brinde à capoeira! Saúde!', fillInBlank: { question: 'sa___de', answer: 'ú' } },
            { portuguese: 'axé', japanese: 'アシェー（エネルギー、幸運）', reading: 'アシェー', explanation: 'ヨルバ語由来の言葉で、ポジティブなエネルギーや生命力、幸運を意味します。ホーダを盛り上げる大切な要素です。', exampleSentence: 'Essa roda tem muito axé!', fillInBlank: { question: 'a___é', answer: 'x' } },
            { portuguese: 'minha', japanese: '私の（女性名詞に付く）', reading: 'ミーニャ', explanation: '所有代名詞。後に続く名詞が女性形の場合に使います。例: minha vida (私の人生)', exampleSentence: 'Essa é minha corda.', fillInBlank: { question: 'mi___a', answer: 'nh' } },
            { portuguese: 'sinhô', japanese: '（昔の）ご主人様', reading: 'シニョー', explanation: 'Senhor（セニョール）が訛った形。奴隷制時代の歌によく登場します。', exampleSentence: 'A canção fala do sinhô de engenho.', fillInBlank: { question: 'si___ô', answer: 'nh' } },
            { portuguese: 'galo', japanese: '雄鶏', reading: 'ガーロ', explanation: 'カポエイラの歌に登場する動物の一つです。', exampleSentence: 'O canto do galo anunciou o dia.', fillInBlank: { question: 'ga___', answer: 'lo' } },
            { portuguese: 'açúcar', japanese: '砂糖', reading: 'アスーカル', explanation: 'ブラジルの歴史、特に奴隷制と深く関わりのある産物です。サトウキビプランテーションが舞台の歌も多いです。', exampleSentence: 'O Brasil foi um grande produtor de açúcar.', fillInBlank: { question: 'açú___', answer: 'car' } },
            { portuguese: 'escravo', japanese: '奴隷', reading: 'エスクラーヴォ', explanation: 'カポエイラの歴史を語る上で避けては通れない言葉です。', exampleSentence: 'Capoeira era uma luta dos escravos.', fillInBlank: { question: 'es___vo', answer: 'cra' } },
            { portuguese: 'cinquenta', japanese: '50', reading: 'シンクエンタ', explanation: '数字の50。', exampleSentence: 'Ele tem cinquenta anos.', fillInBlank: { question: 'cin___nta', answer: 'que' } },
            { portuguese: 'feliz', japanese: '幸せな', reading: 'フェリース', explanation: '感情を表す言葉。', exampleSentence: 'Estou feliz de treinar com vocês.', fillInBlank: { question: 'fe___', answer: 'liz' } },
            { portuguese: 'meu', japanese: '私の（男性名詞に付く）', reading: 'メウ', explanation: '所有代名詞。後に続く名詞が男性形の場合に使います。例: meu mestre (私の先生)', exampleSentence: 'Ele é meu amigo.', fillInBlank: { question: 'm___u', answer: 'e' } },
            { portuguese: 'furacão', japanese: '竜巻', reading: 'フラカォン', explanation: 'ある有名なカポエイリスタのアペリード（ニックネーム）でもあります。', exampleSentence: 'O movimento dele é rápido como um furacão.', fillInBlank: { question: 'fura___', answer: 'cão' } },
            { portuguese: 'azul', japanese: '青', reading: 'アズー', explanation: '色の名前。団体の帯の色などにも使われます。', exampleSentence: 'A bandeira do Brasil é verde, amarela, azul e branca.', fillInBlank: { question: 'a___l', answer: 'zu' } },
            { portuguese: 'atabaque', japanese: 'アタバキ（太鼓）', reading: 'アタバキ', explanation: 'カポエイラの楽器隊（バテリア）で使われる、背の高い太鼓。', exampleSentence: 'O som do atabaque marca o ritmo.', fillInBlank: { question: 'ata___que', answer: 'ba' } },
            { portuguese: 'baqueta', japanese: 'バケータ（ビリンバウのスティック）', reading: 'バケータ', explanation: 'ビリンバウを演奏するための細い棒のことです。', exampleSentence: 'Segure a baqueta com leveza.', fillInBlank: { question: 'ba___ta', answer: 'que' } },
            { portuguese: 'casa', japanese: '家', reading: 'カーザ', explanation: '基本的な単語ですが、練習場所を指して使うこともあります。', exampleSentence: 'Vamos treinar em casa.', fillInBlank: { question: 'ca___', answer: 'sa' } },
            { portuguese: 'Deus', japanese: '神', reading: 'デウス', explanation: '大文字で始まるとキリスト教の唯一神を指します。歌詞にもよく出てきます。', exampleSentence: 'Vá com Deus. (神と共にあれ → さようなら)', fillInBlank: { question: '___us', answer: 'De' } }
        ]
    };

    // --- 会話データ ---
    const conversationData = [
        {
            category: "挨拶",
            items: [
                { japanese: "おはよう", portuguese: "Bom dia", context: "朝の挨拶", example: { speaker1: "Mestre: Bom dia, pessoal!", speaker2: "Aluno: Bom dia, Mestre!" }, fillInBlank: { sentence: "___ dia, pessoal!", answer: "Bom" } },
                { japanese: "こんにちは", portuguese: "Boa tarde", context: "午後の挨拶", example: { speaker1: "Aluno: Boa tarde, galera!", speaker2: "Outro: Boa tarde! Vamos treinar." }, fillInBlank: { sentence: "Boa ___, galera!", answer: "tarde" } },
                { japanese: "こんばんは/おやすみ", portuguese: "Boa noite", context: "夜の挨拶", example: { speaker1: "Mestre: Boa noite e até amanhã.", speaker2: "Aluno: Boa noite, Mestre!" }, fillInBlank: { sentence: "Boa ___, e até amanhã.", answer: "noite" } },
                { japanese: "やあ", portuguese: "Oi / Olá", context: "気軽な挨拶", example: { speaker1: "Aluno: Oi, tudo bem?", speaker2: "Outro: Oi! Tudo joia." }, fillInBlank: { sentence: "___, tudo bem?", answer: "Oi" } },
                { japanese: "さようなら", portuguese: "Tchau / Adeus", context: "別れの挨拶", example: { speaker1: "Aluno: Tchau, pessoal!", speaker2: "Mestre: Tchau! Bom descanso." }, fillInBlank: { sentence: "___, pessoal!", answer: "Tchau" } },
            ]
        },
        {
            category: "状態・様子",
            items: [
                { japanese: "速い", portuguese: "Rápido", context: "動きの速さ", example: { speaker1: "Mestre: Mais rápido!", speaker2: "Aluno: Estou tentando!" }, fillInBlank: { sentence: "O jogo está muito ___.", answer: "rápido" } },
                { japanese: "遅い", portuguese: "Devagar / Lento", context: "動きの速さ", example: { speaker1: "Mestre: Devagar, sinta o movimento.", speaker2: "Aluno: Entendi." }, fillInBlank: { sentence: "Faça a ginga mais ___.", answer: "lenta" } },
                { japanese: "強い", portuguese: "Forte", context: "力の強さ", example: { speaker1: "Mestre: Que chute forte!", speaker2: "Aluno: Obrigado!" }, fillInBlank: { sentence: "Seu chute é muito ___.", answer: "forte" } },
                { japanese: "美しい", portuguese: "Bonito / Belo", context: "動きの美しさ", example: { speaker1: "Mestre: Que movimento bonito!", speaker2: "Aluno: Valeu!" }, fillInBlank: { sentence: "Sua capoeira é muito ___.", answer: "bonita" } },
                { japanese: "高い", portuguese: "Alto", context: "動きの高さ", example: { speaker1: "Mestre: Chute mais alto!", speaker2: "Aluno: Sim, mestre!" }, fillInBlank: { sentence: "Ele pulou bem ___.", answer: "alto" } },
                { japanese: "低い", portuguese: "Baixo", context: "動きの低さ", example: { speaker1: "Mestre: Jogue mais baixo.", speaker2: "Aluno: Ok!" }, fillInBlank: { sentence: "Fique mais ___ na negativa.", answer: "baixo" } },
                { japanese: "暑い", portuguese: "Quente", context: "気温", example: { speaker1: "Aluno: Hoje está muito quente!", speaker2: "Outro: Verdade, preciso de água." }, fillInBlank: { sentence: "Está muito ___ aqui.", answer: "quente" } },
            ]
        },
        {
            category: "動作",
            items: [
                { japanese: "回る", portuguese: "Girar / Rodar", context: "回転する動き", example: { speaker1: "Mestre: Gira sem perder o equilíbrio.", speaker2: "Aluno: Certo." }, fillInBlank: { sentence: "Vamos ___ para o outro lado.", answer: "girar" } },
                { japanese: "動く", portuguese: "Mover / Mexer", context: "体を動かす", example: { speaker1: "Mestre: Mexe o corpo, não fique parado.", speaker2: "Aluno: Ok!" }, fillInBlank: { sentence: "Não pare de se ___.", answer: "mover" } },
                { japanese: "蹴る", portuguese: "Chutar", context: "蹴り技", example: { speaker1: "Mestre: Chuta com mais força.", speaker2: "Aluno: Assim?" }, fillInBlank: { sentence: "Vou ___ a bola.", answer: "chutar" } },
                { japanese: "避ける", portuguese: "Esquivar", context: "攻撃をかわす", example: { speaker1: "Mestre: Esquiva para o lado.", speaker2: "Aluno: Entendi." }, fillInBlank: { sentence: "Aprenda a ___ bem.", answer: "esquivar" } },
                { japanese: "始める", portuguese: "Começar / Iniciar", context: "練習の開始", example: { speaker1: "Mestre: Vamos começar a roda.", speaker2: "Alunos: Vamos!" }, fillInBlank: { sentence: "A aula vai ___.", answer: "começar" } },
            ]
        },
        {
            category: "指示・応答",
            items: [
                { japanese: "質問があります", portuguese: "Tenho uma pergunta", context: "質問したいとき", example: { speaker1: "Aluno: Mestre, tenho uma pergunta.", speaker2: "Mestre: Pode falar." }, fillInBlank: { sentence: "Tenho uma ___.", answer: "pergunta" } },
                { japanese: "わかりました", portuguese: "Entendi / Certo", context: "理解したとき", example: { speaker1: "Mestre: Faça a negativa.", speaker2: "Aluno: Entendi." }, fillInBlank: { sentence: "___, vou fazer isso.", answer: "Certo" } },
                { japanese: "水を飲んでもいいですか？", portuguese: "Posso beber água?", context: "水分補給の許可を求める", example: { speaker1: "Aluno: Estou com sede. Posso beber água?", speaker2: "Mestre: Sim, mas volte rápido." }, fillInBlank: { sentence: "Posso beber ___?", answer: "água" } },
                { japanese: "もう一度お願いします", portuguese: "De novo, por favor", context: "繰り返してほしいとき", example: { speaker1: "Aluno: Não entendi. De novo, por favor.", speaker2: "Mestre: Claro." }, fillInBlank: { sentence: "___, por favor.", answer: "De novo" } },
            ]
        },
        {
            category: "乾杯",
            items: [
                { japanese: "乾杯！", portuguese: "Saúde!", context: "打ち上げなどで", example: { speaker1: "Mestre: Um brinde a todos! Saúde!", speaker2: "Alunos: Saúde!" }, fillInBlank: { sentence: "Um brinde à amizade! ___!", answer: "Saúde" } },
            ]
        }
    ];

    // ===================================================================================
    // APPLICATION LOGIC
    // アプリの動作に関するコードです。通常は編集する必要はありません。
    // ===================================================================================

    // DOM Elements
    const tabButtons = { quiz: document.getElementById('tab-btn-quiz'), conversation: document.getElementById('tab-btn-conversation') };
    const tabContents = { quiz: document.getElementById('tab-content-quiz'), conversation: document.getElementById('tab-content-conversation') };
    const quizSetup = document.getElementById('quiz-setup');
    const quizMain = document.getElementById('quiz-main');
    const quizResults = document.getElementById('quiz-results');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const quitQuizBtn = document.getElementById('quit-quiz-btn');
    const quizSetSelect = document.getElementById('quiz-set');
    const quizTypeSelect = document.getElementById('quiz-type');
    const quizProgress = document.getElementById('quiz-progress');
    const questionLabel = document.getElementById('question-label');
    const questionText = document.getElementById('question-text');
    const speakQuestionMainBtn = document.getElementById('speak-question-main-btn');
    const fillInBlankHint = document.getElementById('fill-in-blank-hint');
    const answerInput = document.getElementById('answer-input');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const feedbackArea = document.getElementById('feedback-area');
    const feedbackText = document.getElementById('feedback-text');
    const explanationArea = document.getElementById('explanation-area');
    const correctAnswerText = document.getElementById('correct-answer-text');
    const explanationText = document.getElementById('explanation-text');
    const exampleSentenceText = document.getElementById('example-sentence-text');
    const speakExampleBtn = document.getElementById('speak-example-btn');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const scoreText = document.getElementById('score-text');
    const mistakesList = document.getElementById('mistakes-list');
    const restartQuizBtn = document.getElementById('restart-quiz-btn');
    const conversationCategorySelect = document.getElementById('conversation-category');
    const conversationDisplay = document.getElementById('conversation-display');
    const cycleViewBtn = document.getElementById('cycle-view-btn');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const messageOkBtn = document.getElementById('message-ok-btn');

    // App State
    let currentTab = 'quiz';
    let quizState = { questions: [], currentIndex: 0, score: 0, mistakes: [], currentQuestion: null };
    let synth = window.speechSynthesis;
    let voices = [];
    let conversationViewMode = 'portuguese'; // 'portuguese', 'japanese', 'full'

    // --- Utility Functions ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function normalizeString(str) {
        if (!str) return '';
        return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function speak(text, event) {
        if(event) event.stopPropagation();
        if (synth.speaking) {
            synth.cancel();
        }
        if (text !== '') {
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.onerror = function (e) {
                console.error('SpeechSynthesisUtterance.onerror', e);
                showMessageBox('音声の再生に失敗しました。ブラウザが対応していないか、音声がロードされていません。');
            }
            const ptBrVoice = voices.find(voice => voice.lang === 'pt-BR');
            utterThis.voice = ptBrVoice ? ptBrVoice : voices.find(voice => voice.lang.startsWith('pt'));
            utterThis.lang = 'pt-BR';
            utterThis.pitch = 1;
            utterThis.rate = 0.9;
            synth.speak(utterThis);
        }
    }
    
    function showMessageBox(text) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
    }

    // --- Tab Switching ---
    function switchTab(tabName) {
        currentTab = tabName;
        for (const key in tabButtons) {
            tabButtons[key].classList.toggle('active', key === tabName);
            tabContents[key].classList.toggle('active', key === tabName);
        }
    }

    // --- Quiz Logic ---
    function startQuiz() {
        const selectedSet = quizSetSelect.value;
        const selectedType = quizTypeSelect.value;
        let questions = (selectedSet === 'mix')
            ? [...quizData.vol1, ...quizData.vol2, ...quizData.vol3]
            : [...quizData[selectedSet]];
        
        if (selectedType === 'fill-in-blank') {
            questions = questions.filter(q => q.fillInBlank && q.fillInBlank.question && q.fillInBlank.answer);
            if (questions.length === 0) {
                showMessageBox('このセットには穴埋め問題がありません。');
                return;
            }
        }

        quizState = {
            questions: shuffleArray(questions),
            currentIndex: 0,
            score: 0,
            mistakes: [],
            currentQuestion: null,
            type: selectedType,
        };

        quizSetup.classList.add('hidden');
        quizResults.classList.add('hidden');
        quizMain.classList.remove('hidden');
        displayQuestion();
    }

    function displayQuestion() {
        if (quizState.currentIndex >= quizState.questions.length) {
            showResults();
            return;
        }

        quizState.currentQuestion = quizState.questions[quizState.currentIndex];
        const q = quizState.currentQuestion;

        quizProgress.textContent = `問題 ${quizState.currentIndex + 1} / ${quizState.questions.length}`;
        answerInput.value = '';
        answerInput.disabled = false;
        submitAnswerBtn.disabled = false;
        feedbackArea.classList.add('hidden');
        
        speakQuestionMainBtn.classList.add('hidden');
        fillInBlankHint.textContent = '';

        switch (quizState.type) {
            case 'meaning':
                questionLabel.textContent = 'この単語の意味は？';
                questionText.textContent = q.portuguese;
                speakQuestionMainBtn.classList.remove('hidden');
                speak(q.portuguese);
                break;
            case 'spelling':
                questionLabel.textContent = 'この意味の単語をポルトガル語で書くと？';
                questionText.textContent = q.japanese.split('（')[0];
                break;
            case 'fill-in-blank':
                questionLabel.textContent = '___ に入る文字は？';
                questionText.textContent = q.fillInBlank.question;
                fillInBlankHint.textContent = `意味: ${q.japanese.split('（')[0]}`;
                break;
        }
        
        answerInput.focus();
    }

    function checkAnswer() {
        const userAnswer = answerInput.value.trim();
        if (userAnswer === '') return;

        const q = quizState.currentQuestion;
        let isCorrect = false;
        let correctAnswer = '';

        switch (quizState.type) {
            case 'meaning':
                correctAnswer = q.japanese.split('（')[0].trim();
                const possibleAnswers = q.japanese.split(/、|,|\//).map(s => s.split('（')[0].trim());
                isCorrect = possibleAnswers.some(ans => userAnswer.toLowerCase() === ans.toLowerCase());
                break;
            case 'spelling':
                correctAnswer = q.portuguese;
                isCorrect = normalizeString(userAnswer) === normalizeString(correctAnswer);
                break;
            case 'fill-in-blank':
                correctAnswer = q.fillInBlank.answer;
                isCorrect = normalizeString(userAnswer) === normalizeString(correctAnswer);
                break;
        }

        answerInput.disabled = true;
        submitAnswerBtn.disabled = true;
        feedbackArea.classList.remove('hidden');
        nextQuestionBtn.focus();

        if (isCorrect) {
            feedbackText.textContent = '正解！ (Correcto!)';
            feedbackText.className = 'text-2xl font-bold text-green-500';
            quizState.score++;
        } else {
            feedbackText.textContent = '不正解 (Errado)';
            feedbackText.className = 'text-2xl font-bold text-red-500';
            quizState.mistakes.push(q);
        }

        const finalAnswer = quizState.type === 'fill-in-blank' ? q.portuguese : correctAnswer;
        correctAnswerText.textContent = `正解: ${finalAnswer}`;
        explanationText.textContent = q.explanation;
        exampleSentenceText.textContent = `例文: ${q.exampleSentence}`;
    }

    function showResults() {
        quizMain.classList.add('hidden');
        quizResults.classList.remove('hidden');
        const percentage = Math.round((quizState.score / quizState.questions.length) * 100);
        scoreText.textContent = `${percentage}% (${quizState.score} / ${quizState.questions.length} 正解)`;
        mistakesList.innerHTML = '<h3 class="font-bold text-xl mb-4">間違えた問題</h3>';
        if (quizState.mistakes.length === 0) {
            mistakesList.innerHTML += '<p>全問正解です！Parabéns!</p>';
        } else {
            const list = document.createElement('ul');
            list.className = 'space-y-4';
            quizState.mistakes.forEach(q => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-red-50 rounded-md';
                li.innerHTML = `<p class="font-semibold">${q.portuguese}</p><p class="text-gray-700">${q.japanese}</p>`;
                list.appendChild(li);
            });
            mistakesList.appendChild(list);
        }
    }

    function quitQuiz() {
        quizMain.classList.add('hidden');
        quizResults.classList.add('hidden');
        quizSetup.classList.remove('hidden');
    }

    // --- Conversation Logic ---
    function populateConversationCategories() {
        conversationData.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.category;
            option.textContent = cat.category;
            conversationCategorySelect.appendChild(option);
        });
    }

    function loadConversationCategory(categoryName) {
        const category = conversationData.find(c => c.category === categoryName);
        if (!category) return;

        conversationDisplay.innerHTML = '';
        category.items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg bg-white shadow-sm conversation-card';
            
            const fillInBlankHTML = item.fillInBlank ? `
                <div class="mt-4 pt-4 border-t conv-fill-in-blank" data-full-sentence="${item.portuguese}">
                    <p class="text-sm font-semibold mb-2">穴埋め練習:</p>
                    <div class="flex items-center text-lg">
                        ${item.fillInBlank.sentence.replace('___', `<input type="text" class="fill-in-blank-input" data-answer="${item.fillInBlank.answer}">`)}
                    </div>
                </div>
            ` : '';

            const speaker1Text = item.example.speaker1.split(/:(.*)/s)[1].trim();
            const speaker2Text = item.example.speaker2.split(/:(.*)/s)[1].trim();

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg text-blue-700 conv-pt" data-lang="pt">${item.portuguese}</p>
                        <p class="text-gray-600 conv-jp" data-lang="jp">${item.japanese}</p>
                        <p class="text-xs text-gray-400 mt-1 conv-details">${item.context}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="speak-phrase-btn text-gray-500 hover:text-blue-500" title="再生" data-speak="${item.portuguese}">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-gray-50 rounded-md text-sm conv-details">
                    <div class="flex items-center justify-between">
                        <p><strong>Mestre:</strong> ${speaker1Text}</p>
                        <i class="fas fa-volume-up speak-btn speak-example-line-btn" data-speak="${speaker1Text}"></i>
                    </div>
                    <div class="flex items-center justify-between mt-1">
                        <p><strong>Aluno:</strong> ${speaker2Text}</p>
                        <i class="fas fa-volume-up speak-btn speak-example-line-btn" data-speak="${speaker2Text}"></i>
                    </div>
                </div>
                ${fillInBlankHTML}
            `;
            conversationDisplay.appendChild(card);
        });
        applyConversationView();
    }
    
    function cycleConversationView() {
        if (conversationViewMode === 'portuguese') {
            conversationViewMode = 'japanese';
        } else if (conversationViewMode === 'japanese') {
            conversationViewMode = 'full';
        } else {
            conversationViewMode = 'portuguese';
        }
        applyConversationView();
    }

    function applyConversationView() {
        const allCards = document.querySelectorAll('.conversation-card');
        
        allCards.forEach(card => {
            const pt = card.querySelector('.conv-pt');
            const jp = card.querySelector('.conv-jp');
            const details = card.querySelectorAll('.conv-details');
            const fillInBlank = card.querySelector('.conv-fill-in-blank');

            // Reset visibility
            pt.classList.remove('hidden');
            jp.classList.remove('hidden');
            details.forEach(d => d.classList.remove('hidden'));
            if (fillInBlank) fillInBlank.classList.remove('hidden');

            if (conversationViewMode === 'portuguese') {
                jp.classList.add('hidden');
                details.forEach(d => d.classList.add('hidden'));
                if (fillInBlank) fillInBlank.classList.add('hidden');
            } else if (conversationViewMode === 'japanese') {
                pt.classList.add('hidden');
                details.forEach(d => d.classList.add('hidden'));
            } else { // 'full'
                if (fillInBlank) fillInBlank.classList.add('hidden');
            }
        });

        // Update button text/icon
        if (conversationViewMode === 'portuguese') {
            cycleViewBtn.innerHTML = `<i class="fas fa-language mr-2"></i>日本語訳で練習`;
        } else if (conversationViewMode === 'japanese') {
            cycleViewBtn.innerHTML = `<i class="fas fa-eye mr-2"></i>詳細を表示`;
        } else { // 'full'
            cycleViewBtn.innerHTML = `<i class="fas fa-eye-slash mr-2"></i>シンプル表示`;
        }
    }
    
    // --- Event Listeners ---
    window.addEventListener('DOMContentLoaded', () => {
        switchTab('quiz');

        function populateVoiceList() {
            voices = synth.getVoices();
        }
        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        // Quiz events
        startQuizBtn.addEventListener('click', startQuiz);
        quitQuizBtn.addEventListener('click', quitQuiz);
        submitAnswerBtn.addEventListener('click', checkAnswer);
        answerInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkAnswer(); });
        nextQuestionBtn.addEventListener('click', () => {
            quizState.currentIndex++;
            displayQuestion();
        });
        restartQuizBtn.addEventListener('click', startQuiz);
        speakQuestionMainBtn.addEventListener('click', (e) => speak(quizState.currentQuestion.portuguese, e));
        speakExampleBtn.addEventListener('click', (e) => speak(quizState.currentQuestion.exampleSentence, e));
        
        // Conversation events
        populateConversationCategories();
        loadConversationCategory(conversationCategorySelect.value);
        conversationCategorySelect.addEventListener('change', (e) => loadConversationCategory(e.target.value));
        cycleViewBtn.addEventListener('click', cycleConversationView);

        conversationDisplay.addEventListener('click', (e) => {
            const speakBtn = e.target.closest('.speak-phrase-btn, .speak-example-line-btn');
            if (speakBtn) {
                speak(speakBtn.dataset.speak, e);
            }
        });
        
        conversationDisplay.addEventListener('input', (e) => {
            const inputEl = e.target;
            if (inputEl.matches('.fill-in-blank-input')) {
                const userAnswer = inputEl.value.trim();
                const correctAnswer = inputEl.dataset.answer;
                if (normalizeString(userAnswer) === normalizeString(correctAnswer)) {
                    inputEl.style.borderColor = '#22c55e';
                    inputEl.style.color = '#22c55e';
                    inputEl.disabled = true;
                    
                    const container = inputEl.closest('.conv-fill-in-blank');
                    if (container && container.dataset.fullSentence) {
                        speak(container.dataset.fullSentence);
                    }
                } else {
                    inputEl.style.borderColor = '#ef4444';
                }
            }
        });
        
        messageOkBtn.addEventListener('click', () => messageBox.classList.add('hidden'));
    });
    </script>
</body>
</html>
