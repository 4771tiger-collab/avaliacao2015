<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カポエイラ・ポルトガル語学習アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 基本フォント設定 */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* カスタムスタイル */
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .sound-icon {
            cursor: pointer;
            color: #3b82f6;
            margin-left: 0.5rem;
            font-size: 1.25rem;
        }
        .sound-icon:hover {
            color: #2563eb;
        }
        
        /* アニメーション */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">Capoeira Português</h1>
            <p class="text-gray-600 mt-2">カポエイラで学ぶポルトガル語</p>
        </header>

        <!-- タブナビゲーション -->
        <div class="flex justify-center mb-8 bg-white p-2 rounded-xl shadow-sm">
            <button id="tab-quiz" class="tab-button w-1/2 py-3 px-4 rounded-lg font-semibold">単語クイズ</button>
            <button id="tab-conversation" class="tab-button w-1/2 py-3 px-4 rounded-lg font-semibold">会話トレーニング</button>
        </div>

        <!-- コンテンツエリア -->
        <main id="content-area">
            <!-- 単語クイズタブ -->
            <div id="quiz-content" class="fade-in">
                <!-- クイズ設定画面 -->
                <div id="quiz-setup" class="card p-6 md:p-8 text-center">
                    <h2 class="text-2xl font-bold mb-6 text-blue-600">単語クイズ設定</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-lg font-medium mb-2">問題セット</label>
                            <select id="quiz-volume" class="w-full max-w-xs mx-auto p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="vol1">Vol. 1</option>
                                <option value="vol2">Vol. 2</option>
                                <option value="vol3">Vol. 3</option>
                                <option value="mix">ミックス (Vol. 1-3)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-lg font-medium mb-2">出題形式</label>
                            <div id="quiz-type-selector" class="flex flex-col sm:flex-row justify-center gap-3">
                                <button data-type="pt-ja" class="btn btn-secondary flex-1">ポルトガル語 → 日本語</button>
                                <button data-type="ja-pt" class="btn btn-secondary flex-1">日本語 → ポルトガル語</button>
                                <button data-type="fill-in" class="btn btn-secondary flex-1">穴埋め問題</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- クイズ実行画面 -->
                <div id="quiz-main" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div id="quiz-progress" class="text-xl font-semibold text-gray-600"></div>
                        <button id="quit-quiz-btn" class="btn btn-secondary btn-sm">トップに戻る</button>
                    </div>
                    <div class="card p-6 md:p-8">
                        <div id="question-area" class="text-center mb-6">
                            <p id="question-text" class="text-2xl md:text-3xl font-bold"></p>
                            <p id="question-hint" class="text-gray-500 mt-2"></p>
                        </div>
                        <div class="flex flex-col gap-4">
                            <input type="text" id="answer-input" class="w-full p-3 border border-gray-300 rounded-lg text-lg text-center focus:ring-2 focus:ring-blue-500" placeholder="答えを入力">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button id="submit-answer" class="btn btn-primary flex-1">決定</button>
                                <button id="skip-question" class="btn btn-secondary flex-1">分からない</button>
                            </div>
                        </div>
                    </div>
                    <div id="feedback-area" class="mt-6"></div>
                </div>

                <!-- クイズ結果画面 -->
                <div id="quiz-results" class="hidden card p-6 md:p-8 text-center fade-in">
                    <h2 class="text-2xl font-bold mb-4 text-blue-600">クイズ結果</h2>
                    <div id="score" class="text-4xl font-bold mb-2"></div>
                    <div id="score-percentage" class="text-lg text-gray-600 mb-6"></div>
                    <div id="mistakes-list" class="text-left"></div>
                    <button id="retry-quiz" class="btn btn-primary mt-8">もう一度挑戦する</button>
                </div>
            </div>

            <!-- 会話トレーニングタブ -->
            <div id="conversation-content" class="hidden fade-in">
                <div class="flex justify-center mb-6">
                    <button id="toggle-view-mode" class="btn btn-secondary">
                        <i class="fas fa-eye mr-2"></i>
                        <span id="view-mode-text">表示切替</span>
                    </button>
                </div>
                <div id="conversation-list" class="space-y-6">
                    <!-- カテゴリとフレーズはJSで生成 -->
                </div>
            </div>
        </main>
    </div>

    <script>
    // --- データ定義 ---
    // すべての問題、解答、会話文、解説、和訳をここに格納します。
    // 後からコンテンツの追加や編集がしやすいように、分かりやすい構造にしています。

    const quizData = {
        vol1: [
            { portuguese: "carrinho", japanese: "手押し車、小さな車", explanation: "語頭のr、語中のrrはハ行で発音します。nhはニャ行の音になります。", example_pt: "Cuidado com o carrinho de mão.", example_ja: "手押し車に気をつけて。" },
            { portuguese: "bolsa", japanese: "バッグ、かばん", explanation: "母音と子音に挟まれたlは「ウ」のように発音されます。", example_pt: "Esqueci minha bolsa na academia.", example_ja: "道場にかばんを忘れました。" },
            { portuguese: "real", japanese: "レアル（通貨）、現実の", explanation: "語末のlも「ウ」のように発音されます。", example_pt: "Isso custa dez reais.", example_ja: "これは10レアルです。" },
            { portuguese: "quinze", japanese: "15", explanation: "quiは通常「キ」と発音されます。", example_pt: "Temos quinze minutos de pausa.", example_ja: "15分間の休憩があります。" },
            { portuguese: "ritmo", japanese: "リズム", explanation: "カポエイラの音楽やジョーゴにおいて非常に重要な要素です。", example_pt: "Siga o ritmo do berimbau.", example_ja: "ビリンバウのリズムについていって。" },
            { portuguese: "respeito", japanese: "敬意", explanation: "カポエイラでは師や仲間への敬意が重んじられます。", example_pt: "Tenha respeito pelo seu mestre.", example_ja: "先生に敬意を払いなさい。" },
            { portuguese: "regional", japanese: "地域の", explanation: "カポエイラ・ヘジョナウはメストリ・ビンバが創始したスタイルです。", example_pt: "Eu pratico Capoeira Regional.", example_ja: "私はカポエイラ・ヘジョナウを練習しています。" },
            { portuguese: "mais uma vez", japanese: "もう一回", explanation: "練習中によく使われるフレーズです。", example_pt: "Vamos tentar mais uma vez.", example_ja: "もう一回やってみよう。" },
            { portuguese: "devagar", japanese: "ゆっくり", explanation: "動きを正確に学ぶために、ゆっくり動くことを指示する際に使われます。", example_pt: "Faça o movimento devagar.", example_ja: "その動きをゆっくりやりなさい。" },
            { portuguese: "tudo bem", japanese: "元気です、大丈夫です", explanation: "挨拶への返答として頻繁に使われます。", example_pt: "Oi, tudo bem?", example_ja: "やあ、元気？" },
            { portuguese: "parabéns", japanese: "おめでとう", explanation: "誕生日や昇段など、お祝いの場面で使います。", example_pt: "Parabéns pela sua nova corda!", example_ja: "新しい帯、おめでとう！" },
            { portuguese: "vinte", japanese: "20", explanation: "数字の20です。", example_pt: "Vamos fazer vinte flexões.", example_ja: "腕立て伏せを20回やりましょう。" },
            { portuguese: "direita", japanese: "右", explanation: "動きの方向を指示する際に使います。", example_pt: "Esquiva para a direita.", example_ja: "右に避けて。" },
            { portuguese: "esquerda", japanese: "左", explanation: "動きの方向を指示する際に使います。", example_pt: "Chuta com a perna esquerda.", example_ja: "左足で蹴って。" },
            { portuguese: "faca", japanese: "ナイフ", explanation: "カポエイラの歴史や歌に登場することがあります。", example_pt: "A letra da música fala sobre uma faca.", example_ja: "その歌の歌詞はナイフについて歌っている。" },
            { portuguese: "corrido", japanese: "コヒード（歌の形式）", explanation: "カポエイラの歌の形式の一つで、短いコールアンドレスポンスが特徴です。", example_pt: "Vamos cantar um corrido.", example_ja: "コヒードを歌いましょう。" },
            { portuguese: "quadra", japanese: "クアドラ（歌の形式）", explanation: "カポエイラの歌の形式の一つで、4行詩が特徴です。", example_pt: "Essa música é uma quadra.", example_ja: "この歌はクアドラです。" },
            { portuguese: "vermelho", japanese: "赤", explanation: "色の名前です。帯の色などで使われます。", example_pt: "A corda dele é vermelha.", example_ja: "彼の帯は赤色です。" }
        ],
        vol2: [
            { portuguese: "xaréu", japanese: "魚の名前", explanation: "xの発音は単語ごとに覚える必要があります。この場合は「シャ」行の音です。", example_pt: "O pescador pegou um xaréu.", example_ja: "漁師はシャレウを捕まえた。" },
            { portuguese: "chapéu", japanese: "帽子", explanation: "chは「シャ」行の音です。「シャペウ・ジ・コウロ」という技があります。", example_pt: "Ele usa um chapéu de palha.", example_ja: "彼は麦わら帽子をかぶっている。" },
            { portuguese: "sequência", japanese: "連続、シークエンス", explanation: "技の連続動作のこと。queは「クェ」と発音します。", example_pt: "Vamos praticar a sequência de Mestre Bimba.", example_ja: "メストリ・ビンバのシークエンスを練習しよう。" },
            { portuguese: "dendê", japanese: "デンデ油", explanation: "バイーア料理に欠かせないアブラヤシの実から採れる油。カポエイラでは「気迫」や「巧妙さ」の比喩として使われます。", example_pt: "Essa roda tem muito dendê.", example_ja: "このホーダは気迫に満ちている。" },
            { portuguese: "oi", japanese: "やあ", explanation: "英語の'Hi'にあたるカジュアルな挨拶です。", example_pt: "Oi, galera!", example_ja: "やあ、みんな！" },
            { portuguese: "queixo", japanese: "あご", explanation: "技の名前「ケイシャーダ（Queixada）」の語源です。", example_pt: "Levante o queixo.", example_ja: "あごを上げて。" },
            { portuguese: "cabeça", japanese: "頭", explanation: "技の名前「カベサーダ（Cabeçada）」は頭突きを意味します。", example_pt: "Proteja sua cabeça.", example_ja: "自分の頭を守って。" },
            { portuguese: "cotovelo", japanese: "ひじ", explanation: "技の名前「コトヴェラーダ（Cotovelada）」は肘打ちを意味します。", example_pt: "Cuidado com o cotovelo.", example_ja: "肘に気をつけて。" },
            { portuguese: "joelho", japanese: "ひざ", explanation: "技の名前「ジョエラーダ（Joelhada）」は膝蹴りを意味します。", example_pt: "Dobre os joelhos.", example_ja: "膝を曲げて。" },
            { portuguese: "quinto", japanese: "5番目の", explanation: "順序を表す数詞です。", example_pt: "Ele é o quinto da fila.", example_ja: "彼は列の5番目です。" },
            { portuguese: "Que legal!", japanese: "いいね！, すごい！", explanation: "ポジティブな感情を表す感嘆表現です。", example_pt: "Você vai para o Brasil? Que legal!", example_ja: "ブラジルに行くの？すごいね！" },
            { portuguese: "tchau", japanese: "バイバイ", explanation: "別れの際のカジュアルな挨拶です。", example_pt: "Tchau, até amanhã!", example_ja: "バイバイ、また明日！" },
            { portuguese: "jogo", japanese: "ジョーゴ、試合", explanation: "カポエイラの組手のこと。", example_pt: "Vamos fazer um jogo.", example_ja: "ジョーゴをしよう。" },
            { portuguese: "Salvador", japanese: "サルヴァドール", explanation: "ブラジル・バイーア州の州都。カポエイラの聖地とされています。", example_pt: "Salvador é a capital da Bahia.", example_ja: "サルヴァドールはバイーアの州都です。" },
            { portuguese: "Bahia", japanese: "バイーア", explanation: "ブラジル北東部の州。アフロ・ブラジル文化の中心地です。", example_pt: "A capoeira nasceu na Bahia.", example_ja: "カポエイラはバイーアで生まれた。" },
            { portuguese: "Igreja do Bonfim", japanese: "ボンフィン教会", explanation: "サルヴァドールにある有名な教会。願いが叶うとされるリボン（フィタ）が有名です。", example_pt: "Amarrei a fita do Bonfim no meu pulso.", example_ja: "ボンフィンのリボンを手首に結んだ。" },
            { portuguese: "peixe", japanese: "魚", explanation: "カポエイラの歌によく登場する単語です。", example_pt: "Eu gosto de comer peixe.", example_ja: "私は魚を食べるのが好きです。" }
        ],
        vol3: [
            { portuguese: "saúde", japanese: "健康、乾杯", explanation: "語末のdeは「ジ」と発音します。乾杯の音頭としても使われます。", example_pt: "Um brinde à sua saúde!", example_ja: "あなたの健康に乾杯！" },
            { portuguese: "axé", japanese: "アシェ（エネルギー、生命力）", explanation: "カポエイラにおけるポジティブなエネルギーや魂のこと。xは「シェ」と発音します。", example_pt: "Essa roda tem muito axé.", example_ja: "このホーダはアシェに満ちている。" },
            { portuguese: "minha", japanese: "私の（女性名詞）", explanation: "所有代名詞。nhは「ニャ」行で発音します。", example_pt: "Essa é minha academia.", example_ja: "これが私の道場です。" },
            { portuguese: "sinhô", japanese: "旦那様", explanation: "senhor（主人）が訛った形。奴隷制時代の歴史を反映した言葉です。", example_pt: "A música fala do sinhô de engenho.", example_ja: "その歌は砂糖農園の主人について歌っている。" },
            { portuguese: "galo", japanese: "雄鶏", explanation: "カポエイラの歌にしばしば登場します。", example_pt: "O canto do galo me acordou.", example_ja: "雄鶏の鳴き声で目が覚めた。" },
            { portuguese: "açúcar", japanese: "砂糖", explanation: "ブラジルの奴隷制の歴史と深く関わる単語です。", example_pt: "O Brasil exportava muito açúcar.", example_ja: "ブラジルは多くの砂糖を輸出していました。" },
            { portuguese: "escravo", japanese: "奴隷", explanation: "カポエイラの起源を語る上で欠かせない言葉です。", example_pt: "A capoeira era uma forma de luta dos escravos.", example_ja: "カポエイラは奴隷たちの闘いの形でした。" },
            { portuguese: "cinquenta", japanese: "50", explanation: "数字の50です。", example_pt: "Ele tem cinquenta anos.", example_ja: "彼は50歳です。" },
            { portuguese: "feliz", japanese: "幸せな", explanation: "感情を表す形容詞です。", example_pt: "Estou feliz em jogar capoeira.", example_ja: "カポエイラができて幸せです。" },
            { portuguese: "meu", japanese: "私の（男性名詞）", explanation: "所有代名詞。男性名詞の前に置きます。", example_pt: "Esse é meu berimbau.", example_ja: "これは私のビリンバウです。" },
            { portuguese: "furacão", japanese: "竜巻", explanation: "有名なカポエイリスタのアペリード（あだ名）でもあります。", example_pt: "O vento parecia um furacão.", example_ja: "風が竜巻のようでした。" },
            { portuguese: "azul", japanese: "青", explanation: "色の名前。ブラジル国旗にも使われています。", example_pt: "O céu está azul hoje.", example_ja: "今日、空は青い。" },
            { portuguese: "atabaque", japanese: "アタバキ（太鼓）", explanation: "カポエイラの楽器隊（バテリア）で使われる太鼓です。", example_pt: "O som do atabaque é forte.", example_ja: "アタバキの音は力強い。" },
            { portuguese: "baqueta", japanese: "バケータ（撥）", explanation: "ビリンバウやアタバキを叩くための棒（撥）です。", example_pt: "Eu preciso de uma baqueta nova.", example_ja: "新しいバケータが必要です。" },
            { portuguese: "casa", japanese: "家", explanation: "基本的な単語です。", example_pt: "Vou para casa agora.", example_ja: "今から家に帰ります。" },
            { portuguese: "Deus", japanese: "神", explanation: "文頭でなくても大文字で書くのが一般的です。", example_pt: "Graças a Deus, está tudo bem.", example_ja: "おかげさまで、すべて順調です。" }
        ]
    };

    const conversationData = [
        {
            category: "挨拶",
            phrases: [
                { portuguese: "Bom dia", japanese: "おはよう", context: "朝クラスの開始前", example: [{ speaker: "Mestre", pt: "Bom dia, pessoal! Prontos para começar?", ja: "おはよう、みんな！始める準備はできた？" }, { speaker: "Aluno", pt: "Bom dia, Mestre! Sim!", ja: "おはようございます、先生！はい！" }] },
                { portuguese: "Boa tarde", japanese: "こんにちは", context: "午後のクラス開始", example: [{ speaker: "Aluno", pt: "Boa tarde, pessoal!", ja: "こんにちは、みんな！" }, { speaker: "Outro aluno", pt: "Boa tarde! Vamos treinar.", ja: "こんにちは！練習しよう。" }] },
                { portuguese: "Boa noite", japanese: "こんばんは", context: "夜のクラス終了後", example: [{ speaker: "Mestre", pt: "Boa noite e até a próxima aula.", ja: "こんばんは、次のクラスで会いましょう。" }, { speaker: "Aluno", pt: "Boa noite, Mestre!", ja: "おやすみなさい、先生！" }] },
                { portuguese: "Oi / Olá", japanese: "やあ", context: "道場に入ってきたときの軽い挨拶", example: [{ speaker: "Aluno", pt: "Oi, galera!", ja: "やあ、みんな！" }, { speaker: "Outro aluno", pt: "Oi! Preparado para jogar?", ja: "やあ！ホーダやる準備できてる？" }] },
                { portuguese: "Tchau / Adeus", japanese: "さようなら", context: "クラスが終わって帰るとき", example: [{ speaker: "Aluno", pt: "Tchau, pessoal! Até amanhã!", ja: "じゃあね、みんな！また明日！" }, { speaker: "Mestre", pt: "Tchau! Treinem em casa também!", ja: "じゃあね！家でも練習してね！" }] }
            ]
        },
        {
            category: "状態・様子",
            phrases: [
                { portuguese: "Rápido", japanese: "速い", context: "ホーダ中、相手の動きが素早い", example: [{ speaker: "Mestre", pt: "Mais rápido, mais rápido!", ja: "もっと速く、もっと速く！" }, { speaker: "Aluno", pt: "Estou tentando, Mestre!", ja: "頑張ってます、先生！" }] },
                { portuguese: "Devagar / Lento", japanese: "遅い", context: "技の練習で動作が急ぎすぎている", example: [{ speaker: "Mestre", pt: "Devagar, para sentir o movimento.", ja: "ゆっくり、動きを感じて。" }, { speaker: "Aluno", pt: "Entendi, mais lento.", ja: "わかりました、もっとゆっくりですね。" }] },
                { portuguese: "Forte", japanese: "強い", context: "蹴りの力加減をほめる", example: [{ speaker: "Mestre", pt: "Chute forte, muito bom!", ja: "強い蹴りだ、すごくいい！" }, { speaker: "Aluno", pt: "Obrigado, Mestre!", ja: "ありがとうございます、先生！" }] },
                { portuguese: "Fraco", japanese: "弱い", context: "もっと力を入れてほしいとき", example: [{ speaker: "Mestre", pt: "Mais forte, está muito fraco.", ja: "もっと強く、今は弱すぎるよ。" }, { speaker: "Aluno", pt: "Vou tentar de novo.", ja: "もう一度やってみます。" }] },
                { portuguese: "Quente", japanese: "暑い", context: "夏の練習中", example: [{ speaker: "Aluno", pt: "Está muito quente hoje!", ja: "今日はめちゃくちゃ暑いですね！" }, { speaker: "Outro aluno", pt: "Sim, preciso de água.", ja: "そう、本当に水が必要だ。" }] },
                { portuguese: "Frio", japanese: "寒い", context: "冬の早朝クラス", example: [{ speaker: "Aluno", pt: "Está frio, preciso me aquecer.", ja: "寒いな、体を温めないと。" }, { speaker: "Mestre", pt: "Vamos começar com a ginga para esquentar.", ja: "ジンガから始めて温めよう。" }] },
                { portuguese: "Bonito / Belo", japanese: "美しい", context: "動きの美しさを褒める", example: [{ speaker: "Mestre", pt: "Que movimento bonito!", ja: "なんて美しい動きだ！" }, { speaker: "Aluno", pt: "Valeu! Treinei muito.", ja: "ありがとう！たくさん練習しました。" }] },
                { portuguese: "Bom / Boa", japanese: "良い", context: "技がうまくできたとき", example: [{ speaker: "Mestre", pt: "Muito bom, continue assim.", ja: "とてもいい、その調子で続けて。" }, { speaker: "Aluno", pt: "Sim, Mestre!", ja: "はい、先生！" }] },
                { portuguese: "Alto", japanese: "高い", context: "蹴りが高く上がったとき", example: [{ speaker: "Mestre", pt: "Chute alto, ótimo!", ja: "高い蹴りだ、すばらしい！" }, { speaker: "Aluno", pt: "Quero chegar mais alto.", ja: "もっと高くしたいです。" }] },
                { portuguese: "Baixo", japanese: "低い", context: "低い姿勢で動く指示", example: [{ speaker: "Mestre", pt: "Fique mais baixo na negativa.", ja: "ネガチーヴァはもっと低く構えて。" }, { speaker: "Aluno", pt: "Está bem, Mestre.", ja: "わかりました、先生。" }] }
            ]
        },
        {
            category: "動作",
            phrases: [
                { portuguese: "Girar / Rodar", japanese: "回る", context: "アウーやメイア・ルーア・ジ・フレンチの練習", example: [{ speaker: "Mestre", pt: "Gira mais rápido, sem perder o equilíbrio.", ja: "もっと速く回って、バランスを崩さないように。" }, { speaker: "Aluno", pt: "Certo, vou tentar.", ja: "わかりました、やってみます。" }] },
                { portuguese: "Mover / Mexer", japanese: "動く", context: "相手の位置に合わせて間合いを取る練習", example: [{ speaker: "Mestre", pt: "Mexe o corpo, não fique parado.", ja: "体を動かして、止まったままにならない。" }, { speaker: "Aluno", pt: "Estou me deslocando, Mestre.", ja: "移動しています、先生。" }] },
                { portuguese: "Chutar", japanese: "蹴る", context: "マルテーロの練習中", example: [{ speaker: "Mestre", pt: "Chuta mais alto, com controle.", ja: "もっと高く蹴って、コントロールして。" }, { speaker: "Aluno", pt: "Assim está bom?", ja: "これくらいでいいですか？" }] },
                { portuguese: "Esquivar", japanese: "避ける", context: "コンビネーション練習で攻撃をかわす", example: [{ speaker: "Mestre", pt: "Esquiva para o lado e contra-ataca.", ja: "横に避けて、反撃して。" }, { speaker: "Aluno", pt: "Entendi, Mestre.", ja: "わかりました、先生。" }] },
                { portuguese: "Parar", japanese: "止まる", context: "動きをいったん中断する指示", example: [{ speaker: "Mestre", pt: "Para! Vamos corrigir o movimento.", ja: "止まって！動きを直そう。" }, { speaker: "Aluno", pt: "Certo.", ja: "はい。" }] },
                { portuguese: "Começar / Iniciar", japanese: "始める", context: "新しいドリルを始めるとき", example: [{ speaker: "Mestre", pt: "Vamos começar com a ginga.", ja: "まずはジンガから始めよう。" }, { speaker: "Aluno", pt: "Já estou pronto.", ja: "もう準備できています。" }] },
                { portuguese: "Acertar / Bater", japanese: "当てる", context: "コンタクトありのミット練習", example: [{ speaker: "Mestre", pt: "Acerta no centro do alvo.", ja: "標的の中心に当てて。" }, { speaker: "Aluno", pt: "Acertei, Mestre?", ja: "当たりましたか、先生？" }] }
            ]
        },
        {
            category: "名詞・その他",
            phrases: [
                { portuguese: "Direita", japanese: "右", context: "動きの方向を指示するとき", example: [{ speaker: "Mestre", pt: "Ginga para a direita.", ja: "右にジンガして。" }, { speaker: "Aluno", pt: "Direita, entendi.", ja: "右ですね、わかりました。" }] },
                { portuguese: "Esquerda", japanese: "左", context: "回避方向の指示", example: [{ speaker: "Mestre", pt: "Esquiva para a esquerda.", ja: "左に避けて。" }, { speaker: "Aluno", pt: "Certo, esquerda.", ja: "わかりました、左ですね。" }] },
                { portuguese: "Fila", japanese: "列", context: "順番待ちの並びを作るとき", example: [{ speaker: "Mestre", pt: "Façam uma fila para praticar.", ja: "練習のために列を作って。" }, { speaker: "Aluno", pt: "Aqui está a fila, Mestre.", ja: "ここに列ができました、先生。" }] },
                { portuguese: "Pergunta", japanese: "質問", context: "生徒が技について聞く", example: [{ speaker: "Aluno", pt: "Tenho uma pergunta sobre a negativa.", ja: "ネガチーヴァについて質問があります。" }, { speaker: "Mestre", pt: "Claro, pode perguntar.", ja: "もちろん、質問していいよ。" }] },
                { portuguese: "Dupla", japanese: "2人組", context: "ペアを組んで練習するとき", example: [{ speaker: "Mestre", pt: "Formem duplas para o próximo exercício.", ja: "次の練習のために2人組を作って。" }, { speaker: "Aluno", pt: "Eu e ele somos dupla.", ja: "僕と彼がペアです。" }] },
                { portuguese: "Sede", japanese: "喉が渇く", context: "練習中に生徒が水を求める", example: [{ speaker: "Aluno", pt: "Estou com sede, posso beber água?", ja: "喉が渇きました、水を飲んでもいいですか？" }, { speaker: "Mestre", pt: "Sim, mas rápido.", ja: "いいよ、でも早くね。" }] },
                { portuguese: "Água", japanese: "水", context: "休憩中", example: [{ speaker: "Mestre", pt: "Bebam água para não desidratar.", ja: "脱水しないように水を飲みなさい。" }, { speaker: "Aluno", pt: "Já bebi, Mestre.", ja: "もう飲みました、先生。" }] },
                { portuguese: "Abdominais", japanese: "腹筋", context: "ウォームアップや体幹強化の時間", example: [{ speaker: "Mestre", pt: "Vamos fazer 30 abdominais.", ja: "腹筋を30回やるぞ。" }, { speaker: "Aluno", pt: "Mestre, posso fazer mais rápido?", ja: "先生、もっと速くやっていいですか？" }, { speaker: "Mestre", pt: "Sim, mas com técnica correta.", ja: "いいけど、正しいフォームでね。" }] }
            ]
        },
        {
            category: "乾杯",
            phrases: [
                { portuguese: "Saúde / Um brinde", japanese: "乾杯", context: "カポエイラ仲間との飲み会やバチザード後の打ち上げ", example: [{ speaker: "Mestre", pt: "Um brinde à nossa roda de hoje! Saúde!", ja: "今日のホーダに乾杯！ 健康を祝して！" }, { speaker: "Alunos", pt: "Saúde!", ja: "乾杯！" }] }
            ]
        }
    ];

    // --- アプリケーションロジック ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- 要素の取得 ---
        const tabQuiz = document.getElementById('tab-quiz');
        const tabConversation = document.getElementById('tab-conversation');
        const quizContent = document.getElementById('quiz-content');
        const conversationContent = document.getElementById('conversation-content');
        const quizSetup = document.getElementById('quiz-setup');
        const quizMain = document.getElementById('quiz-main');
        const quizResults = document.getElementById('quiz-results');
        const quitQuizBtn = document.getElementById('quit-quiz-btn');
        const quizVolumeSelect = document.getElementById('quiz-volume');
        const quizTypeSelector = document.getElementById('quiz-type-selector');
        const quizProgress = document.getElementById('quiz-progress');
        const questionText = document.getElementById('question-text');
        const questionHint = document.getElementById('question-hint');
        const answerInput = document.getElementById('answer-input');
        const submitAnswerBtn = document.getElementById('submit-answer');
        const skipQuestionBtn = document.getElementById('skip-question');
        const feedbackArea = document.getElementById('feedback-area');
        const scoreDiv = document.getElementById('score');
        const scorePercentageDiv = document.getElementById('score-percentage');
        const mistakesListDiv = document.getElementById('mistakes-list');
        const retryQuizBtn = document.getElementById('retry-quiz');
        const conversationList = document.getElementById('conversation-list');
        const toggleViewModeBtn = document.getElementById('toggle-view-mode');
        const viewModeText = document.getElementById('view-mode-text');

        // --- 状態管理 ---
        let currentTab = 'quiz';
        let quizState = {};
        let conversationState = { mode: 0 }; // 0: PT, 1: JA, 2: Detail
        let portugueseVoice = null;
        let voicesLoaded = false; // 音声が読み込まれたかを追跡するフラグ

        // --- 音声合成 ---
        const synth = window.speechSynthesis;

        const loadVoices = () => {
            const voices = synth.getVoices();
            if (voices.length > 0) {
                portugueseVoice = voices.find(voice => voice.lang === 'pt-BR');
                if (!portugueseVoice) {
                    portugueseVoice = voices.find(voice => voice.lang.startsWith('pt'));
                }
                voicesLoaded = true;
                if (speechSynthesis.onvoiceschanged) {
                    speechSynthesis.onvoiceschanged = null;
                }
            }
        };

        loadVoices();
        if (!voicesLoaded && 'onvoiceschanged' in speechSynthesis) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        const speak = (text) => {
            if (!voicesLoaded) {
                loadVoices();
            }

            if (synth.speaking) {
                synth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 0.9;
            if (portugueseVoice) {
                utterance.voice = portugueseVoice;
            } else {
                console.warn('pt-BR voice not found. Using browser default for pt-BR. Please ensure a Portuguese voice is installed in your OS.');
            }
            synth.speak(utterance);
        };

        // --- ヘルパー関数 ---
        const normalizeString = (str) => {
            return str.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        };

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const createFillInBlank = (word) => {
            const vowels = "aeiouáéíóúâêôãõ";
            let blanked = "";
            for (let i = 0; i < word.length; i++) {
                if (i === 0 || i === word.length - 1 || !vowels.includes(word[i].toLowerCase())) {
                    blanked += word[i];
                } else {
                    blanked += "_";
                }
            }
            if (blanked.replace(/_/g, '').length <= 2 && word.length > 2) {
                const midIndex = Math.floor(word.length / 2);
                const charArray = blanked.split('');
                charArray[midIndex] = word[midIndex];
                return charArray.join('');
            }
            return blanked;
        };

        // --- タブ切り替え ---
        const showTab = (tabName) => {
            currentTab = tabName;
            if (tabName === 'quiz') {
                quizContent.style.display = 'block';
                conversationContent.style.display = 'none';
                tabQuiz.classList.add('active');
                tabConversation.classList.remove('active');
            } else {
                quizContent.style.display = 'none';
                conversationContent.style.display = 'block';
                tabQuiz.classList.remove('active');
                tabConversation.classList.add('active');
            }
        };

        // --- クイズ機能 ---
        const startQuiz = (type) => {
            const volume = quizVolumeSelect.value;
            let questions = [];
            if (volume === 'mix') {
                questions = [...quizData.vol1, ...quizData.vol2, ...quizData.vol3];
            } else {
                questions = [...quizData[volume]];
            }

            quizState = {
                questions: shuffleArray(questions).slice(0, 10),
                currentQuestionIndex: 0,
                score: 0,
                type: type,
                mistakes: []
            };

            quizSetup.style.display = 'none';
            quizResults.style.display = 'none';
            quizMain.style.display = 'block';
            displayQuestion();
        };

        const displayQuestion = () => {
            feedbackArea.innerHTML = '';
            answerInput.value = '';
            answerInput.focus();

            if (quizState.currentQuestionIndex >= quizState.questions.length) {
                showResults();
                return;
            }

            const q = quizState.questions[quizState.currentQuestionIndex];
            quizProgress.textContent = `問題 ${quizState.currentQuestionIndex + 1} / ${quizState.questions.length}`;

            switch (quizState.type) {
                case 'pt-ja':
                    questionText.innerHTML = `${q.portuguese} <i class="fas fa-volume-up sound-icon" data-speak-text="${q.portuguese}"></i>`;
                    questionHint.textContent = 'この単語の意味は？';
                    break;
                case 'ja-pt':
                    questionText.textContent = q.japanese;
                    questionHint.textContent = 'ポルトガル語で何と言う？';
                    break;
                case 'fill-in':
                    questionText.textContent = createFillInBlank(q.portuguese);
                    questionHint.textContent = `ヒント: ${q.japanese}`;
                    break;
            }
        };

        const checkAnswer = () => {
            const userAnswer = answerInput.value.trim();
            if (!userAnswer) return;

            const q = quizState.questions[quizState.currentQuestionIndex];
            let isCorrect = false;

            if (quizState.type === 'pt-ja') {
                const correctAnswers = q.japanese.split(/[、,]/).map(ans => ans.trim());
                isCorrect = correctAnswers.includes(userAnswer);
            } else { // ja-pt or fill-in
                const correctAnswer = q.portuguese;
                isCorrect = normalizeString(userAnswer) === normalizeString(correctAnswer);
            }

            if (isCorrect) {
                quizState.score++;
            } else {
                quizState.mistakes.push(q);
            }
            
            showFeedback(isCorrect, q);
        };
        
        const skipQuestion = () => {
            const q = quizState.questions[quizState.currentQuestionIndex];
            quizState.mistakes.push(q);
            showFeedback(false, q);
        };

        const showFeedback = (isCorrect, question) => {
            const resultClass = isCorrect ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            const resultText = isCorrect ? '正解！' : '不正解';
            const iconClass = isCorrect ? 'fa-check-circle' : 'fa-times-circle';

            feedbackArea.innerHTML = `
                <div class="card p-6 fade-in ${resultClass}">
                    <div class="flex items-center text-2xl font-bold mb-4">
                        <i class="fas ${iconClass} mr-3"></i>
                        <span>${resultText}</span>
                    </div>
                    <div class="space-y-3 text-left">
                        <p class="text-lg">
                            <strong class="font-semibold">${question.portuguese}</strong>
                            <i class="fas fa-volume-up sound-icon" data-speak-text="${question.portuguese}"></i>
                            <span class="text-gray-600"> : ${question.japanese}</span>
                        </p>
                        <p><strong class="font-semibold">解説:</strong> ${question.explanation}</p>
                        <p>
                            <strong class="font-semibold">例文:</strong> ${question.example_pt}
                            <i class="fas fa-volume-up sound-icon" data-speak-text="${question.example_pt}"></i>
                            <br>
                            <span class="text-gray-500 text-sm">${question.example_ja}</span>
                        </p>
                    </div>
                    <button id="next-question" class="btn btn-primary w-full mt-6">次へ</button>
                </div>
            `;
            
            if (isCorrect) {
                speak(question.portuguese);
            }

            document.getElementById('next-question').addEventListener('click', nextQuestion);
            document.getElementById('next-question').focus();
        };

        const nextQuestion = () => {
            quizState.currentQuestionIndex++;
            displayQuestion();
        };

        const showResults = () => {
            quizMain.style.display = 'none';
            quizResults.style.display = 'block';

            const total = quizState.questions.length;
            const percentage = total > 0 ? Math.round((quizState.score / total) * 100) : 0;

            scoreDiv.textContent = `${quizState.score} / ${total}`;
            scorePercentageDiv.textContent = `正答率: ${percentage}%`;

            if (quizState.mistakes.length > 0) {
                mistakesListDiv.innerHTML = '<h3 class="text-xl font-bold mb-4 text-left text-red-600">間違えた問題</h3>';
                const list = document.createElement('ul');
                list.className = 'space-y-2';
                quizState.mistakes.forEach(q => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-red-50 rounded-lg';
                    li.innerHTML = `<strong>${q.portuguese}</strong>: ${q.japanese}`;
                    list.appendChild(li);
                });
                mistakesListDiv.appendChild(list);
            } else {
                mistakesListDiv.innerHTML = '<p class="text-green-600 font-bold text-xl mt-6">素晴らしい！全問正解です！</p>';
            }
        };

        // --- 会話トレーニング機能 ---
        const renderConversations = () => {
            conversationList.innerHTML = '';
            conversationData.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'card p-4 md:p-6';
                let phrasesHTML = '';
                category.phrases.forEach((phrase, index) => {
                    let exampleHTML = '';
                    phrase.example.forEach(line => {
                        exampleHTML += `
                            <div class="flex items-start mt-2">
                                <span class="font-semibold w-24">${line.speaker}:</span>
                                <div class="flex-1">
                                    <span>${line.pt}</span>
                                    <i class="fas fa-volume-up sound-icon" data-speak-text="${line.pt}"></i>
                                    <p class="text-gray-500 text-sm">${line.ja}</p>
                                </div>
                            </div>
                        `;
                    });

                    phrasesHTML += `
                        <div class="phrase-item py-4 ${index > 0 ? 'border-t border-gray-200' : ''}">
                            <div class="portuguese-view">
                                <p class="text-lg font-semibold">
                                    ${phrase.portuguese}
                                    <i class="fas fa-volume-up sound-icon" data-speak-text="${phrase.portuguese}"></i>
                                </p>
                            </div>
                            <div class="japanese-view hidden">
                                <p class="text-lg">${phrase.japanese}</p>
                            </div>
                            <div class="detail-view hidden">
                                <p class="text-lg font-semibold">${phrase.portuguese}: <span class="font-normal">${phrase.japanese}</span></p>
                                <p class="text-sm text-gray-500 mt-1"><strong>場面:</strong> ${phrase.context}</p>
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg">${exampleHTML}</div>
                            </div>
                        </div>
                    `;
                });

                categoryDiv.innerHTML = `
                    <h3 class="text-xl font-bold mb-2 text-blue-600">${category.category}</h3>
                    ${phrasesHTML}
                `;
                conversationList.appendChild(categoryDiv);
            });
            updateConversationView();
        };

        const updateConversationView = () => {
            const allPhrases = document.querySelectorAll('.phrase-item');
            allPhrases.forEach(item => {
                const ptView = item.querySelector('.portuguese-view');
                const jaView = item.querySelector('.japanese-view');
                const detailView = item.querySelector('.detail-view');

                ptView.style.display = 'none';
                jaView.style.display = 'none';
                detailView.style.display = 'none';

                switch(conversationState.mode) {
                    case 0: // PTのみ
                        ptView.style.display = 'block';
                        viewModeText.textContent = 'ポルトガル語のみ';
                        break;
                    case 1: // JAのみ
                        jaView.style.display = 'block';
                        viewModeText.textContent = '日本語で練習';
                        break;
                    case 2: // 詳細
                        detailView.style.display = 'block';
                        viewModeText.textContent = '詳細表示';
                        break;
                }
            });
        };

        const toggleConversationMode = () => {
            conversationState.mode = (conversationState.mode + 1) % 3;
            updateConversationView();
        };


        // --- イベントリスナー設定 ---
        tabQuiz.addEventListener('click', () => showTab('quiz'));
        tabConversation.addEventListener('click', () => showTab('conversation'));

        quizTypeSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                startQuiz(e.target.dataset.type);
            }
        });
        
        submitAnswerBtn.addEventListener('click', checkAnswer);
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        skipQuestionBtn.addEventListener('click', skipQuestion);

        retryQuizBtn.addEventListener('click', () => {
            quizResults.style.display = 'none';
            quizSetup.style.display = 'block';
        });
        
        quitQuizBtn.addEventListener('click', () => {
            quizMain.style.display = 'none';
            quizSetup.style.display = 'block';
            feedbackArea.innerHTML = '';
        });

        toggleViewModeBtn.addEventListener('click', toggleConversationMode);

        // Delegated event listener for all sound icons
        document.body.addEventListener('click', (e) => {
            if (e.target.matches('.sound-icon')) {
                const text = e.target.dataset.speakText;
                if (text) {
                    speak(text);
                }
            }
        });

        // --- 初期化処理 ---
        const init = () => {
            showTab('quiz');
            renderConversations();
        };

        init();
    });
    </script>
</body>
</html>
